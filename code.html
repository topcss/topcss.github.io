<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AirScan Ultimate v2 | 稳定传输版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, sans-serif; -webkit-tap-highlight-color: transparent; }
        .matrix-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 8px; width: 100%; aspect-ratio: 1/1; padding: 8px; background: #fff; border-radius: 16px; border: 1px solid #e2e8f0; }
        canvas.qr-cell { width: 100% !important; height: 100% !important; image-rendering: pixelated; }
        .scan-mask { position: absolute; inset: 0; pointer-events: none; z-index: 10; }
        .scan-quadrant { border: 1px dashed rgba(255,255,255,0.3); transition: background 0.1s; }
        .scan-quadrant.active { background: rgba(34, 197, 94, 0.3); border: 2px solid #22c55e; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

<header class="bg-white px-4 py-3 shadow-sm z-20 flex justify-between items-center shrink-0">
    <h1 class="text-lg font-black tracking-tighter text-indigo-600">AirScan <span class="text-slate-900">v2</span></h1>
    <div class="flex bg-slate-100 p-1 rounded-lg">
        <button onclick="app.switchTab('send')" id="tab-s" class="px-4 py-1.5 rounded-md text-xs font-bold bg-white text-indigo-600 shadow-sm transition-all">发送</button>
        <button onclick="app.switchTab('receive')" id="tab-r" class="px-4 py-1.5 rounded-md text-xs font-bold text-slate-500 transition-all">接收</button>
    </div>
</header>

<main id="panel-send" class="flex-1 flex flex-col overflow-y-auto p-4 space-y-4 max-w-lg mx-auto w-full">
    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
        <div class="flex gap-4 mb-4 border-b pb-2">
            <label class="text-sm font-bold"><input type="radio" name="im" checked onclick="sender.toggleMode('file')"> 文件</label>
            <label class="text-sm font-bold"><input type="radio" name="im" onclick="sender.toggleMode('text')"> 文本</label>
        </div>
        <div id="area-file">
            <div onclick="document.getElementById('fi').click()" class="border-2 border-dashed border-slate-200 rounded-xl p-6 text-center hover:bg-slate-50 cursor-pointer">
                <p class="text-xs text-slate-500">点击选择文件 (支持中文文件名)</p>
            </div>
            <input type="file" id="fi" class="hidden" onchange="sender.handleFile(this.files[0])">
        </div>
        <div id="area-text" class="hidden">
            <textarea id="ti" class="w-full bg-slate-50 p-3 rounded-xl border text-sm h-24" placeholder="输入内容..."></textarea>
            <button onclick="sender.handleText()" class="mt-2 w-full py-2 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold">确认</button>
        </div>
        <div id="si" class="hidden mt-4 bg-indigo-50 p-3 rounded-lg flex justify-between items-center animate-pulse">
            <div class="overflow-hidden"><p id="sn" class="text-xs font-bold truncate"></p><p id="ss" class="text-[10px]"></p></div>
            <button onclick="sender.reset()" class="text-xs font-bold text-red-500">重置</button>
        </div>
    </div>

    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex-1 flex flex-col min-h-0">
        <div class="relative flex-1 flex items-center justify-center">
            <div id="mc" class="matrix-grid opacity-20 blur-sm">
                <canvas id="qr1" class="qr-cell"></canvas><canvas id="qr2" class="qr-cell"></canvas>
                <canvas id="qr3" class="qr-cell"></canvas><canvas id="qr4" class="qr-cell"></canvas>
            </div>
            <div id="so" class="absolute inset-0 flex items-center justify-center z-10">
                <button id="bs" onclick="sender.start()" disabled class="bg-indigo-600 text-white px-8 py-3 rounded-full font-bold shadow-lg disabled:bg-slate-300 transform active:scale-95 transition">开始广播</button>
            </div>
        </div>
        <div id="sc" class="hidden mt-4 pt-4 border-t flex justify-between items-center font-mono text-[10px]">
            <span>PKGS: <b id="pc">0</b></span>
            <button onclick="sender.stop()" class="text-red-500 font-bold">⏹ 停止</button>
        </div>
    </div>
</main>

<main id="panel-receive" class="hidden flex-1 flex flex-col p-4 space-y-4 max-w-lg mx-auto w-full h-full">
    <div class="flex gap-1">
        <button onclick="receiver.setSrc('environment')" class="flex-1 bg-white border py-2 rounded text-[10px] font-bold">后置</button>
        <button onclick="receiver.setSrc('user')" class="flex-1 bg-white border py-2 rounded text-[10px] font-bold">前置</button>
        <button onclick="receiver.setSrc('screen')" class="flex-1 bg-white border py-2 rounded text-[10px] font-bold">屏幕分享</button>
    </div>
    <div class="relative bg-black rounded-2xl overflow-hidden flex-1 min-h-0">
        <video id="rv" autoplay playsinline class="hidden"></video>
        <canvas id="rc" class="w-full h-full object-cover"></canvas>
        <div class="scan-mask grid grid-cols-2 grid-rows-2">
            <div id="q-tl" class="scan-quadrant border-r border-b"></div><div id="q-tr" class="scan-quadrant border-b"></div>
            <div id="q-bl" class="scan-quadrant border-r"></div><div id="q-br" class="scan-quadrant"></div>
        </div>
    </div>
    <div id="rsc" class="bg-white p-4 rounded-2xl shadow-lg hidden">
        <div id="rpv">
            <div class="flex justify-between mb-2">
                <div class="flex-1 min-w-0 pr-2"><h3 id="rn" class="text-xs font-bold truncate"></h3><p id="rs" class="text-[10px] text-slate-400"></p></div>
                <div class="text-right"><p class="text-[10px] text-slate-400">ETA</p><p id="re" class="text-xs font-mono font-bold text-indigo-600">--:--</p></div>
            </div>
            <div class="h-1.5 bg-slate-100 rounded-full overflow-hidden"><div id="rb" class="h-full bg-indigo-500 w-0 transition-all"></div></div>
            <div class="mt-2 flex justify-between text-[10px] font-bold"><span id="rp">0</span>% <button onclick="receiver.stop()" class="text-red-500">中止</button></div>
        </div>
        <div id="rcv" class="hidden text-center py-2">
            <p class="text-green-600 font-bold text-sm">接收成功!</p>
            <p class="text-[10px] text-slate-400 my-2">耗时: <span id="rst"></span> | 效率: <span id="rsp"></span>/s</p>
            <div class="flex gap-2"><button onclick="receiver.reset()" class="flex-1 py-2 bg-slate-100 rounded text-xs">重置</button><button id="bd" class="flex-[2] py-2 bg-indigo-600 text-white rounded text-xs font-bold shadow-lg">下载文件</button></div>
        </div>
    </div>
</main>

<script>
// 数学与转换工具
const Utils = {
    fS: (b) => b < 1024 ? b + ' B' : b < 1048576 ? (b / 1024).toFixed(1) + ' KB' : (b / 1048576).toFixed(1) + ' MB',
    fT: (s) => isFinite(s) && s >= 0 ? `${Math.floor(s/60)}:${Math.floor(s%60).toString().padStart(2,'0')}` : "--:--",
    PRNG: (s) => () => { s = (s * 16807) % 2147483647; return (s - 1) / 2147483646; },
    // UTF-8 转 Base64 解决中文问题
    u2b: (u8) => btoa(Array.from(u8).map(b => String.fromCharCode(b)).join('')),
    b2u: (str) => new Uint8Array(atob(str).split('').map(c => c.charCodeAt(0)))
};

const app = { switchTab: (t) => {
    document.getElementById('panel-send').classList.toggle('hidden', t!=='send');
    document.getElementById('panel-receive').classList.toggle('hidden', t!=='receive');
    document.getElementById('tab-s').className = t==='send' ? "px-4 py-1.5 rounded-md text-xs font-bold bg-white text-indigo-600 shadow-sm transition-all" : "px-4 py-1.5 rounded-md text-xs font-bold text-slate-500";
    document.getElementById('tab-r').className = t==='receive' ? "px-4 py-1.5 rounded-md text-xs font-bold bg-white text-indigo-600 shadow-sm transition-all" : "px-4 py-1.5 rounded-md text-xs font-bold text-slate-500";
    t === 'receive' ? sender.stop() : receiver.stop();
}};

const sender = {
    data: null, chunks: [], timer: null, qrs: [], pC: 0, fps: 15, cS: 180, // 减小 cS 提高二维码识别成功率
    init: () => { ['qr1','qr2','qr3','qr4'].forEach(id => sender.qrs.push(new QRious({element:document.getElementById(id), size:280, level:'L'}))); },
    toggleMode: (m) => { document.getElementById('area-file').classList.toggle('hidden', m!=='file'); document.getElementById('area-text').classList.toggle('hidden', m!=='text'); sender.reset(); },
    handleFile: (f) => { if(!f) return; sender.m = { n: f.name, s: f.size }; const r = new FileReader(); r.onload = (e) => { sender.data = new Uint8Array(e.target.result); sender.prep(); }; r.readAsArrayBuffer(f); },
    handleText: () => { const t = document.getElementById('ti').value; if(!t) return; sender.data = new TextEncoder().encode(t); sender.m = { n: "text_"+Date.now().toString().slice(-4)+".txt", s: sender.data.length }; sender.prep(); },
    prep: () => {
        sender.chunks = [];
        for(let i=0; i<sender.data.length; i+=sender.cS) {
            let b = sender.data.slice(i, i+sender.cS);
            if(b.length < sender.cS) { let t = new Uint8Array(sender.cS); t.set(b); b = t; }
            sender.chunks.push(b);
        }
        document.getElementById('si').classList.remove('hidden');
        document.getElementById('sn').innerText = sender.m.n;
        document.getElementById('ss').innerText = Utils.fS(sender.m.s);
        document.getElementById('bs').disabled = false;
    },
    start: () => { 
        sender.tid = Math.random().toString(36).slice(-3);
        document.getElementById('mc').classList.remove('opacity-20', 'blur-sm');
        document.getElementById('so').classList.add('hidden');
        document.getElementById('sc').classList.remove('hidden');
        sender.timer = setInterval(sender.tick, 1000/sender.fps);
    },
    stop: () => { clearInterval(sender.timer); sender.timer = null; document.getElementById('mc').classList.add('opacity-20', 'blur-sm'); document.getElementById('so').classList.remove('hidden'); document.getElementById('sc').classList.add('hidden'); },
    reset: () => { sender.stop(); sender.data = null; document.getElementById('fi').value = ''; document.getElementById('ti').value = ''; document.getElementById('si').classList.add('hidden'); document.getElementById('bs').disabled = true; },
    tick: () => {
        const L = sender.chunks.length;
        for(let i=0; i<4; i++){
            sender.pC++;
            const s = Math.floor(Math.random()*1000000);
            const rng = Utils.PRNG(s);
            let d = rng() < 0.5 ? 1 : rng() < 0.8 ? 2 : Math.min(L, Math.floor(rng()*5)+2);
            const idxs = []; while(idxs.length < d){ let x = Math.floor(rng()*L); if(!idxs.includes(x)) idxs.push(x); }
            const xor = new Uint8Array(sender.cS);
            idxs.forEach(idx => { for(let j=0; j<sender.cS; j++) xor[j] ^= sender.chunks[idx][j]; });
            // 协议优化：[TID]|[Seed]|[Total]|[B64Data]|[EncodedMeta]
            const meta = encodeURIComponent(sender.m.n) + ":" + sender.m.s;
            sender.qrs[i].value = `${sender.tid}|${s}|${L}|${Utils.u2b(xor)}|${meta}`;
        }
        document.getElementById('pc').innerText = sender.pC;
    }
};

const receiver = {
    v: document.getElementById('rv'), c: document.getElementById('rc'), s: null, sc: false, solved: {}, coll: new Set(), q: [],
    init: () => { receiver.ctx = receiver.c.getContext('2d', {willReadFrequently:true}); },
    setSrc: async (t) => {
        receiver.reset(); receiver.init();
        try {
            receiver.s = (t==='screen') ? await navigator.mediaDevices.getDisplayMedia({video:true}) : await navigator.mediaDevices.getUserMedia({video:{facingMode:t}});
            receiver.v.srcObject = receiver.s; receiver.sc = true; requestAnimationFrame(receiver.loop);
        } catch(e) { alert("开启失败"); }
    },
    stop: () => { receiver.sc = false; if(receiver.s) receiver.s.getTracks().forEach(t => t.stop()); },
    reset: () => { receiver.stop(); receiver.tid = null; receiver.coll.clear(); receiver.solved = {}; receiver.q = []; document.getElementById('rsc').classList.add('hidden'); },
    loop: () => {
        if(!receiver.sc) return;
        if(receiver.v.readyState === receiver.v.HAVE_ENOUGH_DATA){
            const w = receiver.v.videoWidth, h = receiver.videoHeight;
            receiver.c.width = w; receiver.c.height = h; receiver.ctx.drawImage(receiver.v, 0, 0, w, h);
            const mX = w/2, mY = h/2;
            const regs = [{id:'full',x:0,y:0,w:w,h:h},{id:'q-tl',x:0,y:0,w:mX,h:mY},{id:'q-tr',x:mX,y:0,w:mX,h:mY},{id:'q-bl',x:0,y:mY,w:mX,h:mY},{id:'q-br',x:mX,y:mY,w:mX,h:mY}];
            document.querySelectorAll('.scan-quadrant').forEach(e => e.classList.remove('active'));
            regs.forEach(r => {
                const d = receiver.ctx.getImageData(r.x, r.y, r.w, r.h);
                const res = jsQR(d.data, d.width, d.height, {inversionAttempts:"dontInvert"});
                if(res){ if(r.id!=='full') document.getElementById(r.id).classList.add('active'); receiver.parse(res.data); }
            });
        }
        requestAnimationFrame(receiver.loop);
    },
    parse: (str) => {
        const p = str.split('|'); if(p.length < 5) return;
        const [tid, sStr, tStr, b64, meta] = p;
        const s = parseInt(sStr), L = parseInt(tStr);
        if(receiver.tid !== tid){
            receiver.tid = tid; receiver.tL = L; receiver.sT = Date.now();
            const [n, sz] = meta.split(':'); receiver.fN = decodeURIComponent(n); receiver.fS = parseInt(sz);
            receiver.coll.clear(); receiver.solved = {}; receiver.q = [];
            document.getElementById('rsc').classList.remove('hidden');
            document.getElementById('rcv').classList.add('hidden');
            document.getElementById('rpv').classList.remove('hidden');
            document.getElementById('rn').innerText = receiver.fN;
            document.getElementById('rs').innerText = Utils.fS(receiver.fS);
        }
        if(receiver.coll.has(s)) return; receiver.coll.add(s);
        const u8 = Utils.b2u(b64);
        const rng = Utils.PRNG(s);
        let d = rng() < 0.5 ? 1 : rng() < 0.8 ? 2 : Math.min(L, Math.floor(rng()*5)+2);
        const idxs = []; while(idxs.length < d){ let x = Math.floor(rng()*L); if(!idxs.includes(x)) idxs.push(x); }
        receiver.q.push({idxs, u8});
        receiver.solve();
    },
    solve: () => {
        let prog = true;
        while(prog){
            prog = false;
            receiver.q.forEach(it => {
                const rem = it.idxs.filter(idx => !receiver.solved[idx]);
                if(rem.length < it.idxs.length){
                    it.idxs.filter(idx => receiver.solved[idx]).forEach(idx => {
                        for(let j=0; j<it.u8.length; j++) it.u8[j] ^= receiver.solved[idx][j];
                    });
                    it.idxs = rem; prog = true;
                }
            });
            const s1 = receiver.queue = receiver.q.filter(it => it.idxs.length > 0).find(it => it.idxs.length === 1);
            if(s1){ let idx = s1.idxs[0]; if(!receiver.solved[idx]){ receiver.solved[idx] = s1.u8; prog = true; } receiver.q = receiver.q.filter(it => it.idxs.length > 1 || (it.idxs.length === 1 && it.idxs[0] !== idx)); }
        }
        const done = Object.keys(receiver.solved).length;
        const pct = Math.floor((done / receiver.tL) * 100);
        document.getElementById('rb').style.width = pct + '%';
        document.getElementById('rp').innerText = pct;
        const elap = (Date.now() - receiver.sT) / 1000;
        if(elap > 1) document.getElementById('re').innerText = Utils.fT((receiver.tL - done) / (done / elap));
        if(done >= receiver.tL) receiver.fin(elap);
    },
    fin: (elap) => {
        receiver.sc = false;
        document.getElementById('rpv').classList.add('hidden');
        document.getElementById('rcv').classList.remove('hidden');
        document.getElementById('rst').innerText = elap.toFixed(1) + 's';
        document.getElementById('rsp').innerText = Utils.fS(receiver.fS / elap);
        const res = new Uint8Array(receiver.tL * sender.cS);
        for(let i=0; i<receiver.tL; i++) res.set(receiver.solved[i], i * sender.cS);
        const blob = new Blob([res.slice(0, receiver.fS)]);
        document.getElementById('bd').onclick = () => { const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = receiver.fN; a.click(); };
    }
};
sender.init();
</script>
</body>
</html>

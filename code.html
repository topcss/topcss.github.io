<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AirScan Ultimate | å…¨èƒ½å…‰å­¦ä¼ è¾“</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .matrix-grid { 
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 4px; 
            width: 100%; aspect-ratio: 1/1; padding: 4px; background: #f1f5f9; border-radius: 16px;
        }
        canvas.qr-cell { width: 100% !important; height: 100% !important; border-radius: 6px; image-rendering: pixelated; }
        .scan-mask { position: absolute; inset: 0; pointer-events: none; border-radius: 12px; overflow: hidden;}
        .scan-quadrant { border: 1px dashed rgba(255,255,255,0.2); box-sizing: border-box; transition: background 0.1s; }
        .scan-quadrant.active { background: rgba(16, 185, 129, 0.2); border: 2px solid #10b981; }
        
        /* éšè—æ»šåŠ¨æ¡ä½†ä¿ç•™åŠŸèƒ½ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden">

<header class="bg-white px-4 py-3 shadow-sm z-20 flex justify-between items-center shrink-0">
    <div>
        <h1 class="text-lg font-black tracking-tighter text-slate-900">AirScan <span class="text-indigo-600">Ultimate</span></h1>
        <p class="text-[10px] text-slate-400 font-mono">FOUNTAIN CODE MATRIX PROTOCOL</p>
    </div>
    <div class="flex bg-slate-100 p-1 rounded-lg">
        <button onclick="app.switchTab('send')" id="tab-s" class="px-4 py-1.5 rounded-md text-xs font-bold bg-white text-indigo-600 shadow-sm transition-all">å‘é€</button>
        <button onclick="app.switchTab('receive')" id="tab-r" class="px-4 py-1.5 rounded-md text-xs font-bold text-slate-500 transition-all">æ¥æ”¶</button>
    </div>
</header>

<main id="panel-send" class="flex-1 flex flex-col overflow-y-auto no-scrollbar p-4 space-y-4 max-w-lg mx-auto w-full">
    
    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
        <div class="flex gap-4 mb-4 border-b border-slate-100 pb-2">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="inputType" value="file" checked onchange="sender.toggleInputMode('file')" class="accent-indigo-600">
                <span class="text-sm font-bold">æ–‡ä»¶æ¨¡å¼</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="inputType" value="text" onchange="sender.toggleInputMode('text')" class="accent-indigo-600">
                <span class="text-sm font-bold">çº¯æ–‡æœ¬æ¨¡å¼</span>
            </label>
        </div>

        <div id="input-file-area">
            <div id="drop-zone" onclick="document.getElementById('fileInput').click()" class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:bg-slate-50 hover:border-indigo-400 transition cursor-pointer">
                <div class="text-3xl mb-2">ğŸ“‚</div>
                <p class="text-xs text-slate-500 font-medium">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–æ‹½æ–‡ä»¶</p>
            </div>
            <input type="file" id="fileInput" class="hidden" onchange="sender.handleFile(this.files[0])">
        </div>

        <div id="input-text-area" class="hidden">
            <textarea id="textInput" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-200 text-sm focus:border-indigo-500 outline-none h-24 resize-none" placeholder="åœ¨æ­¤ç²˜è´´æ–‡æœ¬å†…å®¹..."></textarea>
            <button onclick="sender.handleText()" class="mt-2 w-full py-2 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100">ç¡®è®¤æ–‡æœ¬å†…å®¹</button>
        </div>

        <div id="selected-info" class="hidden mt-4 bg-indigo-50 border border-indigo-100 rounded-lg p-3 flex justify-between items-center">
            <div class="overflow-hidden">
                <p id="send-name" class="text-xs font-bold text-indigo-900 truncate">filename.txt</p>
                <p id="send-size" class="text-[10px] text-indigo-600 font-mono">0 KB</p>
            </div>
            <button onclick="sender.reset()" class="text-xs font-bold text-red-500 px-2">é‡ç½®</button>
        </div>
    </div>

    <details class="bg-white p-3 rounded-xl shadow-sm border border-slate-200">
        <summary class="text-xs font-bold text-slate-500 cursor-pointer list-none flex justify-between">
            <span>ä¼ è¾“å‚æ•° (FPS: <span id="val-fps">15</span>, Size: <span id="val-size">250</span>)</span>
            <span>âš™ï¸</span>
        </summary>
        <div class="mt-4 space-y-3">
            <div class="flex items-center gap-3">
                <span class="text-xs w-12 text-slate-400">FPS</span>
                <input type="range" min="5" max="30" value="15" class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="sender.updateSettings('fps', this.value)">
            </div>
            <div class="flex items-center gap-3">
                <span class="text-xs w-12 text-slate-400">Size</span>
                <input type="range" min="100" max="800" value="250" step="10" class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="sender.updateSettings('size', this.value)">
            </div>
        </div>
    </details>

    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex-1 flex flex-col">
        <div class="relative flex-1 min-h-[250px] flex items-center justify-center">
            <div id="matrix-container" class="matrix-grid opacity-30 blur-[2px] transition duration-300">
                <canvas id="qr1" class="qr-cell"></canvas>
                <canvas id="qr2" class="qr-cell"></canvas>
                <canvas id="qr3" class="qr-cell"></canvas>
                <canvas id="qr4" class="qr-cell"></canvas>
            </div>
            <div id="send-overlay" class="absolute inset-0 flex items-center justify-center z-10">
                <button id="btn-send-start" onclick="sender.start()" disabled class="bg-indigo-600 text-white px-8 py-3 rounded-full font-bold shadow-lg disabled:bg-slate-300 disabled:shadow-none transition transform active:scale-95">å¼€å§‹å¹¿æ’­</button>
            </div>
        </div>
        
        <div id="send-controls" class="hidden mt-4 pt-4 border-t border-slate-100 flex justify-between items-center animate-fade-in">
            <div class="text-xs font-mono text-slate-400">PKGS: <span id="pkg-counter" class="text-slate-800 font-bold">0</span></div>
            <button onclick="sender.stop()" class="bg-red-50 text-red-500 px-4 py-2 rounded-lg text-xs font-bold hover:bg-red-100">â¹ åœæ­¢å¹¿æ’­</button>
        </div>
    </div>
</main>

<main id="panel-receive" class="hidden flex-1 flex flex-col p-4 space-y-4 max-w-lg mx-auto w-full h-full">
    
    <div class="flex gap-2 justify-center">
        <button onclick="receiver.setSource('environment')" class="flex-1 bg-white border border-slate-200 py-2 rounded-lg text-xs font-bold shadow-sm hover:border-indigo-400 focus:ring-2 focus:ring-indigo-500">ğŸ“· åç½®é•œå¤´</button>
        <button onclick="receiver.setSource('user')" class="flex-1 bg-white border border-slate-200 py-2 rounded-lg text-xs font-bold shadow-sm hover:border-indigo-400 focus:ring-2 focus:ring-indigo-500">ğŸ¤³ å‰ç½®é•œå¤´</button>
        <button onclick="receiver.setSource('screen')" class="flex-1 bg-white border border-slate-200 py-2 rounded-lg text-xs font-bold shadow-sm hover:border-indigo-400 focus:ring-2 focus:ring-indigo-500">ğŸ’» å±å¹•/çª—å£</button>
    </div>

    <div class="relative bg-black rounded-2xl overflow-hidden shadow-md flex-1 min-h-[300px]">
        <video id="rx-video" autoplay playsinline class="hidden"></video>
        <canvas id="rx-canvas" class="w-full h-full object-cover"></canvas>
        
        <div class="scan-mask grid grid-cols-2 grid-rows-2">
            <div id="q-tl" class="scan-quadrant border-r border-b"></div>
            <div id="q-tr" class="scan-quadrant border-b"></div>
            <div id="q-bl" class="scan-quadrant border-r"></div>
            <div id="q-br" class="scan-quadrant"></div>
        </div>

        <div id="rx-overlay" class="absolute inset-0 bg-slate-900/80 flex flex-col items-center justify-center text-white z-20">
            <div class="text-4xl mb-4 animate-bounce">ğŸ“¡</div>
            <p class="text-sm font-bold">è¯·é€‰æ‹©ä¸Šæ–¹çš„è§†é¢‘æºå¼€å§‹</p>
        </div>
    </div>

    <div id="rx-status-card" class="bg-white p-4 rounded-2xl shadow-lg border border-slate-100 hidden">
        <div id="rx-progress-view">
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h3 id="rx-filename" class="text-sm font-black text-slate-800 break-all line-clamp-1">æ­£åœ¨è¿æ¥...</h3>
                    <p id="rx-filesize" class="text-xs text-slate-500 font-mono">-- MB</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-slate-400 uppercase font-bold">ETA</p>
                    <p id="rx-eta" class="text-sm font-mono font-bold text-indigo-600">--:--</p>
                </div>
            </div>
            
            <div class="h-2 bg-slate-100 rounded-full overflow-hidden mb-2">
                <div id="rx-bar" class="h-full bg-indigo-500 w-0 transition-all duration-300"></div>
            </div>
            
            <div class="flex justify-between items-center text-[10px] text-slate-500 font-mono font-bold">
                <span><span id="rx-pct">0</span>%</span>
                <button onclick="receiver.stop()" class="bg-slate-100 text-slate-600 px-3 py-1 rounded hover:bg-slate-200">â¹ ä¸­æ­¢</button>
            </div>
        </div>

        <div id="rx-complete-view" class="hidden text-center py-2">
            <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl">âœ“</div>
            <h3 class="text-slate-800 font-bold mb-1">æ¥æ”¶å®Œæˆ</h3>
            <div class="flex justify-center gap-4 text-xs text-slate-500 mb-4 font-mono">
                <span>è€—æ—¶: <span id="rx-stat-time" class="text-slate-800 font-bold">0s</span></span>
                <span>åŒ…æ•°: <span id="rx-stat-pkgs" class="text-slate-800 font-bold">0</span></span>
            </div>
            <div class="flex gap-2">
                <button onclick="receiver.reset()" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm">é‡ç½®</button>
                <button id="btn-download" class="flex-[2] py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-indigo-200">ä¸‹è½½æ–‡ä»¶</button>
            </div>
        </div>
    </div>
</main>

<script>
// ================= å·¥å…·åº“ =================
const Utils = {
    formatSize: (b) => {
        if(b===0) return '0 B';
        const k=1024, s=['B','KB','MB','GB'];
        const i=Math.floor(Math.log(b)/Math.log(k));
        return parseFloat((b/Math.pow(k,i)).toFixed(2))+' '+s[i];
    },
    formatTime: (sec) => {
        if(!isFinite(sec) || sec < 0) return "--:--";
        const m = Math.floor(sec / 60);
        const s = Math.floor(sec % 60);
        return `${m}:${s<10?'0':''}${s}`;
    },
    PRNG: (seed) => {
        return () => {
            let t = seed += 0x6D2B79F5;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }
    }
};

// ================= APP æ§åˆ¶ =================
const app = {
    switchTab: (t) => {
        document.getElementById('panel-send').classList.toggle('hidden', t!=='send');
        document.getElementById('panel-receive').classList.toggle('hidden', t!=='receive');
        
        const btnS = document.getElementById('tab-s');
        const btnR = document.getElementById('tab-r');
        
        if(t==='send') {
            btnS.className = "px-4 py-1.5 rounded-md text-xs font-bold bg-white text-indigo-600 shadow-sm transition-all";
            btnR.className = "px-4 py-1.5 rounded-md text-xs font-bold text-slate-500 transition-all";
            receiver.stop(); // åˆ‡èµ°æ—¶å…³é—­æ¥æ”¶
        } else {
            btnR.className = "px-4 py-1.5 rounded-md text-xs font-bold bg-white text-indigo-600 shadow-sm transition-all";
            btnS.className = "px-4 py-1.5 rounded-md text-xs font-bold text-slate-500 transition-all";
            sender.stop(); // åˆ‡èµ°æ—¶åœæ­¢å‘é€
        }
    }
};

// ================= å‘é€ç«¯é€»è¾‘ =================
const sender = {
    data: null,
    meta: { name: "", size: 0 },
    chunks: [],
    fps: 15,
    chunkSize: 250,
    timer: null,
    tid: null,
    packetCount: 0,
    qrs: [],
    
    init: () => {
        ['qr1','qr2','qr3','qr4'].forEach(id => {
            sender.qrs.push(new QRious({ element: document.getElementById(id), size: 300, level: 'L' }));
        });
    },

    toggleInputMode: (mode) => {
        document.getElementById('input-file-area').classList.toggle('hidden', mode !== 'file');
        document.getElementById('input-text-area').classList.toggle('hidden', mode !== 'text');
        sender.reset(); // åˆ‡æ¢æ¨¡å¼æ—¶é‡ç½®æ•°æ®
    },

    handleFile: (f) => {
        if(!f) return;
        sender.meta = { name: f.name, size: f.size };
        const r = new FileReader();
        r.onload = (e) => {
            sender.data = new Uint8Array(e.target.result);
            sender.uiReady();
        };
        r.readAsArrayBuffer(f);
    },

    handleText: () => {
        const txt = document.getElementById('textInput').value;
        if(!txt) return alert("è¯·è¾“å…¥æ–‡æœ¬");
        const enc = new TextEncoder();
        sender.data = enc.encode(txt);
        sender.meta = { name: "text_snippet.txt", size: sender.data.length };
        sender.uiReady();
    },

    uiReady: () => {
        document.getElementById('selected-info').classList.remove('hidden');
        document.getElementById('send-name').innerText = sender.meta.name;
        document.getElementById('send-size').innerText = Utils.formatSize(sender.meta.size);
        document.getElementById('btn-send-start').disabled = false;
        
        // åˆ‡å—å‡†å¤‡
        sender.chunks = [];
        const size = parseInt(sender.chunkSize);
        for(let i=0; i<sender.data.length; i+=size) {
            let blk = sender.data.slice(i, i+size);
            if(blk.length < size) {
                const tmp = new Uint8Array(size);
                tmp.set(blk);
                blk = tmp;
            }
            sender.chunks.push(blk);
        }
    },

    reset: () => {
        sender.stop();
        sender.data = null;
        sender.chunks = [];
        document.getElementById('fileInput').value = '';
        document.getElementById('textInput').value = '';
        document.getElementById('selected-info').classList.add('hidden');
        document.getElementById('btn-send-start').disabled = true;
    },

    updateSettings: (key, val) => {
        sender[key] = val;
        document.getElementById(`val-${key}`).innerText = val;
        if(sender.timer) sender.restart(); // å®æ—¶ç”Ÿæ•ˆ
    },

    start: () => {
        if(!sender.chunks.length) return;
        sender.tid = Math.floor(Math.random()*999).toString(36);
        sender.packetCount = 0;
        document.getElementById('matrix-container').classList.remove('opacity-30', 'blur-[2px]');
        document.getElementById('send-overlay').classList.add('hidden');
        document.getElementById('send-controls').classList.remove('hidden');
        sender.restart();
    },

    restart: () => {
        clearInterval(sender.timer);
        sender.timer = setInterval(sender.tick, 1000/sender.fps);
    },

    stop: () => {
        clearInterval(sender.timer);
        sender.timer = null;
        document.getElementById('matrix-container').classList.add('opacity-30', 'blur-[2px]');
        document.getElementById('send-overlay').classList.remove('hidden');
        document.getElementById('send-controls').classList.add('hidden');
    },

    tick: () => {
        const total = sender.chunks.length;
        // æ›´æ–°4ä¸ªäºŒç»´ç 
        for(let i=0; i<4; i++) {
            sender.packetCount++;
            const seed = Math.floor(Math.random()*1000000);
            
            // LT Code: éšæœºé€‰å—å¼‚æˆ–
            const rand = Utils.PRNG(seed);
            let degree = 1;
            const r = rand();
            if(r < 0.5) degree=1;
            else if(r < 0.8) degree=2;
            else degree = Math.min(total, Math.ceil(rand()*5)+2);

            const indices = [];
            while(indices.length < degree) {
                const idx = Math.floor(rand()*total);
                if(!indices.includes(idx)) indices.push(idx);
            }

            const xored = new Uint8Array(parseInt(sender.chunkSize));
            indices.forEach(idx => {
                const blk = sender.chunks[idx];
                for(let b=0; b<xored.length; b++) xored[b] ^= blk[b];
            });

            // Protocol: TID|Seed|Total|B64|Meta(Name:Size)
            let b64 = "";
            for(let b=0; b<xored.length; b++) b64 += String.fromCharCode(xored[b]);
            b64 = btoa(b64);
            
            const meta = `${sender.meta.name}:${sender.meta.size}`;
            sender.qrs[i].value = `${sender.tid}|${seed}|${total}|${b64}|${meta}`;
        }
        document.getElementById('pkg-counter').innerText = sender.packetCount;
    }
};

// ================= æ¥æ”¶ç«¯é€»è¾‘ =================
const receiver = {
    video: document.getElementById('rx-video'),
    canvas: document.getElementById('rx-canvas'),
    ctx: null,
    stream: null,
    scanning: false,
    
    // çŠ¶æ€
    tid: null,
    startTime: 0,
    totalBlocks: 0,
    fileName: "",
    fileSize: 0,
    collected: new Set(),
    solved: {},
    queue: [],

    init: () => {
        receiver.ctx = receiver.canvas.getContext('2d', { willReadFrequently: true });
    },

    setSource: async (type) => {
        receiver.stop();
        receiver.init();
        try {
            if(type === 'screen') {
                // æ¡Œé¢åˆ†äº«
                receiver.stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
            } else {
                // æ‘„åƒå¤´ (user/environment)
                receiver.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: type } });
            }
            receiver.video.srcObject = receiver.stream;
            receiver.startScan();
        } catch(e) {
            console.error(e);
            alert("æ— æ³•å¼€å¯è§†é¢‘æºï¼š" + e.message);
        }
    },

    startScan: () => {
        document.getElementById('rx-overlay').classList.add('hidden');
        receiver.scanning = true;
        requestAnimationFrame(receiver.loop);
    },

    stop: () => {
        receiver.scanning = false;
        if(receiver.stream) receiver.stream.getTracks().forEach(t => t.stop());
        receiver.stream = null;
        document.getElementById('rx-overlay').classList.remove('hidden');
    },

    reset: () => {
        receiver.stop();
        receiver.tid = null;
        receiver.collected.clear();
        receiver.solved = {};
        receiver.queue = [];
        document.getElementById('rx-status-card').classList.add('hidden');
        document.getElementById('rx-complete-view').classList.add('hidden');
        document.getElementById('rx-progress-view').classList.remove('hidden');
    },

    loop: () => {
        if(!receiver.scanning) return;
        if(receiver.video.readyState === receiver.video.HAVE_ENOUGH_DATA) {
            const w = receiver.video.videoWidth;
            const h = receiver.video.videoHeight;
            receiver.canvas.width = w;
            receiver.canvas.height = h;
            receiver.ctx.drawImage(receiver.video, 0, 0, w, h);

            // 5åŒºåˆ‡å‰²æ‰«æ (å…¨å± + 4è±¡é™)
            const midX = w/2, midY = h/2;
            const regions = [
                {id:'full', x:0, y:0, w:w, h:h},
                {id:'q-tl', x:0, y:0, w:midX, h:midY},
                {id:'q-tr', x:midX, y:0, w:midX, h:midY},
                {id:'q-bl', x:0, y:midY, w:midX, h:midY},
                {id:'q-br', x:midX, y:midY, w:midX, h:midY},
            ];

            document.querySelectorAll('.scan-quadrant').forEach(e => e.classList.remove('active'));

            regions.forEach(r => {
                const idata = receiver.ctx.getImageData(r.x, r.y, r.w, r.h);
                const code = jsQR(idata.data, r.w, r.h, { inversionAttempts: "dontInvert" });
                if(code) {
                    if(r.id !== 'full') document.getElementById(r.id).classList.add('active');
                    receiver.parse(code.data);
                }
            });
        }
        requestAnimationFrame(receiver.loop);
    },

    parse: (str) => {
        const p = str.split('|');
        if(p.length < 5) return;
        const [tid, seedStr, totalStr, b64, meta] = p;
        const seed = parseInt(seedStr);
        const total = parseInt(totalStr);

        // æ–°ä»»åŠ¡æ£€æµ‹
        if(receiver.tid !== tid) {
            receiver.tid = tid;
            receiver.totalBlocks = total;
            receiver.startTime = Date.now();
            const [fname, fsize] = meta.split(':');
            receiver.fileName = fname;
            receiver.fileSize = parseInt(fsize);
            
            receiver.collected.clear();
            receiver.solved = {};
            receiver.queue = [];
            
            // UIåˆå§‹åŒ–
            document.getElementById('rx-status-card').classList.remove('hidden');
            document.getElementById('rx-complete-view').classList.add('hidden');
            document.getElementById('rx-progress-view').classList.remove('hidden');
            document.getElementById('rx-filename').innerText = fname;
            document.getElementById('rx-filesize').innerText = Utils.formatSize(receiver.fileSize);
        }

        if(receiver.collected.has(seed)) return;
        receiver.collected.add(seed);

        // è§£ç æ•°æ®
        const bin = atob(b64);
        const data = new Uint8Array(bin.length);
        for(let i=0; i<bin.length; i++) data[i] = bin.charCodeAt(i);

        // è¿˜åŸIndices
        const rand = Utils.PRNG(seed);
        let degree = 1;
        const r = rand();
        if(r < 0.5) degree = 1;
        else if(r < 0.8) degree = 2;
        else degree = Math.min(total, Math.ceil(rand()*5)+2);

        const indices = [];
        while(indices.length < degree) {
            const idx = Math.floor(rand()*total);
            if(!indices.includes(idx)) indices.push(idx);
        }

        receiver.queue.push({ indices, data });
        receiver.processQueue();
        receiver.updateStats();
    },

    processQueue: () => {
        let progress = true;
        while(progress) {
            progress = false;
            receiver.queue.forEach(item => {
                const needed = item.indices.filter(idx => !receiver.solved[idx]);
                // å¦‚æœæ‰€éœ€å—å‡å°‘äº†(è¢«å…¶ä»–åŒ…è§£å‡ºæ¥äº†)
                if(needed.length < item.indices.length) {
                    const known = item.indices.filter(idx => receiver.solved[idx]);
                    known.forEach(idx => {
                        const val = receiver.solved[idx];
                        for(let i=0; i<item.data.length; i++) item.data[i] ^= val[i];
                    });
                    item.indices = needed;
                    progress = true;
                }
            });

            // å¯»æ‰¾åº¦ä¸º1çš„åŒ…
            const solvable = receiver.queue.find(i => i.indices.length === 1);
            if(solvable) {
                const idx = solvable.indices[0];
                if(!receiver.solved[idx]) {
                    receiver.solved[idx] = solvable.data;
                    progress = true;
                }
                receiver.queue = receiver.queue.filter(i => i.indices.length > 0);
            }
        }
    },

    updateStats: () => {
        const solvedCount = Object.keys(receiver.solved).length;
        const pct = Math.floor((solvedCount / receiver.totalBlocks) * 100);
        
        // è¿›åº¦æ¡
        document.getElementById('rx-bar').style.width = pct + '%';
        document.getElementById('rx-pct').innerText = pct;

        // ETA è®¡ç®—
        const now = Date.now();
        const elapsed = (now - receiver.startTime) / 1000; // sec
        if(elapsed > 1 && solvedCount > 0) {
            const speed = solvedCount / elapsed; // blocks per sec
            const remaining = receiver.totalBlocks - solvedCount;
            const eta = remaining / speed;
            document.getElementById('rx-eta').innerText = Utils.formatTime(eta);
        }

        if(solvedCount >= receiver.totalBlocks) {
            receiver.finish(elapsed);
        }
    },

    finish: (elapsed) => {
        receiver.scanning = false; // åœæ­¢æ‰«æ
        document.getElementById('rx-progress-view').classList.add('hidden');
        document.getElementById('rx-complete-view').classList.remove('hidden');
        
        // ç»Ÿè®¡
        document.getElementById('rx-stat-time').innerText = elapsed.toFixed(1) + 's';
        document.getElementById('rx-stat-pkgs').innerText = receiver.collected.size;

        // ç»„è£…æ–‡ä»¶
        const chunks = [];
        for(let i=0; i<receiver.totalBlocks; i++) chunks.push(receiver.solved[i]);
        
        const totalLen = chunks.reduce((acc, c) => acc + c.length, 0);
        const fileData = new Uint8Array(totalLen);
        let offset = 0;
        chunks.forEach(c => {
            fileData.set(c, offset);
            offset += c.length;
        });

        const finalData = fileData.slice(0, receiver.fileSize);
        const blob = new Blob([finalData]);
        
        document.getElementById('btn-download').onclick = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = receiver.fileName;
            a.click();
        };
    }
};

sender.init();
</script>
</body>
</html>

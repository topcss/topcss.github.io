<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AirScan Ultimate | å…¨èƒ½å…‰å­¦ä¼ è¾“</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: system-ui, -apple-system, sans-serif; -webkit-tap-highlight-color: transparent; }
        .matrix-grid { 
            display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 4px; 
            width: 100%; aspect-ratio: 1/1; padding: 4px; background: #f1f5f9; border-radius: 16px;
        }
        canvas.qr-cell { width: 100% !important; height: 100% !important; border-radius: 6px; image-rendering: pixelated; }
        .scan-mask { position: absolute; inset: 0; pointer-events: none; border-radius: 12px; overflow: hidden;}
        .scan-quadrant { border: 1px dashed rgba(255,255,255,0.2); box-sizing: border-box; transition: background 0.1s; }
        .scan-quadrant.active { background: rgba(16, 185, 129, 0.2); border: 2px solid #10b981; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800 h-screen flex flex-col overflow-hidden">

<header class="bg-white px-4 py-3 shadow-sm z-20 flex justify-between items-center shrink-0">
    <div>
        <h1 class="text-lg font-black tracking-tighter text-slate-900">AirScan <span class="text-indigo-600">Ultimate</span></h1>
        <p class="text-[10px] text-slate-400 font-mono">FOUNTAIN CODE MATRIX PROTOCOL</p>
    </div>
    <div class="flex bg-slate-100 p-1 rounded-lg">
        <button onclick="app.switchTab('send')" id="tab-s" class="px-4 py-1.5 rounded-md text-xs font-bold bg-white text-indigo-600 shadow-sm transition-all">å‘é€</button>
        <button onclick="app.switchTab('receive')" id="tab-r" class="px-4 py-1.5 rounded-md text-xs font-bold text-slate-500 transition-all">æ¥æ”¶</button>
    </div>
</header>

<main id="panel-send" class="flex-1 flex flex-col overflow-y-auto no-scrollbar p-4 space-y-4 max-w-lg mx-auto w-full">
    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
        <div class="flex gap-4 mb-4 border-b border-slate-100 pb-2">
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="inputType" value="file" checked onchange="sender.toggleInputMode('file')" class="accent-indigo-600">
                <span class="text-sm font-bold">æ–‡ä»¶æ¨¡å¼</span>
            </label>
            <label class="flex items-center gap-2 cursor-pointer">
                <input type="radio" name="inputType" value="text" onchange="sender.toggleInputMode('text')" class="accent-indigo-600">
                <span class="text-sm font-bold">çº¯æ–‡æœ¬æ¨¡å¼</span>
            </label>
        </div>

        <div id="input-file-area">
            <div id="drop-zone" onclick="document.getElementById('fileInput').click()" class="border-2 border-dashed border-slate-300 rounded-xl p-6 text-center hover:bg-slate-50 hover:border-indigo-400 transition cursor-pointer">
                <div class="text-3xl mb-2">ğŸ“‚</div>
                <p class="text-xs text-slate-500 font-medium">ç‚¹å‡»é€‰æ‹©æ–‡ä»¶ (æ”¯æŒä¸­æ–‡æ–‡ä»¶å)</p>
            </div>
            <input type="file" id="fileInput" class="hidden" onchange="sender.handleFile(this.files[0])">
        </div>

        <div id="input-text-area" class="hidden">
            <textarea id="textInput" class="w-full bg-slate-50 p-3 rounded-xl border border-slate-200 text-sm focus:border-indigo-500 outline-none h-24 resize-none" placeholder="åœ¨æ­¤ç²˜è´´æ–‡æœ¬å†…å®¹..."></textarea>
            <button onclick="sender.handleText()" class="mt-2 w-full py-2 bg-indigo-50 text-indigo-600 rounded-lg text-xs font-bold hover:bg-indigo-100">ç¡®è®¤æ–‡æœ¬å†…å®¹</button>
        </div>

        <div id="selected-info" class="hidden mt-4 bg-indigo-50 border border-indigo-100 rounded-lg p-3 flex justify-between items-center">
            <div class="overflow-hidden">
                <p id="send-name" class="text-xs font-bold text-indigo-900 truncate">æœªå‘½å</p>
                <p id="send-size" class="text-[10px] text-indigo-600 font-mono">0 KB</p>
            </div>
            <button onclick="sender.reset()" class="text-xs font-bold text-red-500 px-2">é‡ç½®</button>
        </div>
    </div>

    <details class="bg-white p-3 rounded-xl shadow-sm border border-slate-200">
        <summary class="text-xs font-bold text-slate-500 cursor-pointer list-none flex justify-between">
            <span>ä¼ è¾“å‚æ•° (FPS: <span id="val-fps">12</span>, å—å¤§å°: <span id="val-size">180</span>)</span>
            <span>âš™ï¸</span>
        </summary>
        <div class="mt-4 space-y-3">
            <div class="flex items-center gap-3">
                <span class="text-xs w-12 text-slate-400">FPS</span>
                <input type="range" min="2" max="25" value="12" class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="sender.updateSettings('fps', this.value)">
            </div>
            <div class="flex items-center gap-3">
                <span class="text-xs w-12 text-slate-400">å—å¤§å°</span>
                <input type="range" min="50" max="300" value="180" step="10" class="flex-1 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer" oninput="sender.updateSettings('chunkSize', this.value)">
            </div>
            <p class="text-[10px] text-slate-400">æ³¨ï¼šå—å¤§å°è¶Šå¤§ä¼ è¾“è¶Šå¿«ï¼Œä½†è¯†åˆ«ç‡ä¼šä¸‹é™ã€‚</p>
        </div>
    </details>

    <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex-1 flex flex-col">
        <div class="relative flex-1 min-h-[250px] flex items-center justify-center">
            <div id="matrix-container" class="matrix-grid opacity-30 blur-[2px] transition duration-300">
                <canvas id="qr1" class="qr-cell"></canvas>
                <canvas id="qr2" class="qr-cell"></canvas>
                <canvas id="qr3" class="qr-cell"></canvas>
                <canvas id="qr4" class="qr-cell"></canvas>
            </div>
            <div id="send-overlay" class="absolute inset-0 flex items-center justify-center z-10">
                <button id="btn-send-start" disabled onclick="sender.start()" class="bg-indigo-600 text-white px-8 py-3 rounded-full font-bold shadow-lg disabled:bg-slate-300 disabled:shadow-none transition transform active:scale-95">å¼€å§‹å¹¿æ’­</button>
            </div>
        </div>
        <div id="send-controls" class="hidden mt-4 pt-4 border-t border-slate-100 flex justify-between items-center">
            <div class="text-xs font-mono text-slate-400">PACKETS: <span id="pkg-counter" class="text-slate-800 font-bold">0</span></div>
            <button onclick="sender.stop()" class="bg-red-50 text-red-500 px-4 py-2 rounded-lg text-xs font-bold">åœæ­¢å¹¿æ’­</button>
        </div>
    </div>
</main>

<main id="panel-receive" class="hidden flex-1 flex flex-col p-4 space-y-4 max-w-lg mx-auto w-full h-full">
    <div class="flex gap-2 justify-center">
        <button onclick="receiver.setSource('environment')" class="flex-1 bg-white border border-slate-200 py-2 rounded-lg text-xs font-bold shadow-sm">ğŸ“· åç½®é•œå¤´</button>
        <button onclick="receiver.setSource('user')" class="flex-1 bg-white border border-slate-200 py-2 rounded-lg text-xs font-bold shadow-sm">ğŸ¤³ å‰ç½®é•œå¤´</button>
        <button onclick="receiver.setSource('screen')" class="flex-1 bg-white border border-slate-200 py-2 rounded-lg text-xs font-bold shadow-sm">ğŸ’» å±å¹•å…±äº«</button>
    </div>

    <div class="relative bg-black rounded-2xl overflow-hidden shadow-md flex-1 min-h-[300px]">
        <video id="rx-video" autoplay playsinline class="hidden"></video>
        <canvas id="rx-canvas" class="w-full h-full object-cover"></canvas>
        <div class="scan-mask grid grid-cols-2 grid-rows-2">
            <div id="q-tl" class="scan-quadrant border-r border-b"></div>
            <div id="q-tr" class="scan-quadrant border-b"></div>
            <div id="q-bl" class="scan-quadrant border-r"></div>
            <div id="q-br" class="scan-quadrant"></div>
        </div>
        <div id="rx-overlay" class="absolute inset-0 bg-slate-900/80 flex flex-col items-center justify-center text-white z-20">
            <div class="text-4xl mb-4 animate-bounce">ğŸ“¡</div>
            <p class="text-sm font-bold">è¯·é€‰æ‹©ä¸Šæ–¹çš„è§†é¢‘æºå¼€å§‹</p>
        </div>
    </div>

    <div id="rx-status-card" class="bg-white p-4 rounded-2xl shadow-lg border border-slate-100 hidden">
        <div id="rx-progress-view">
            <div class="flex justify-between items-start mb-3">
                <div>
                    <h3 id="rx-filename" class="text-sm font-black text-slate-800 truncate max-w-[150px]">æ­£åœ¨è¯†åˆ«...</h3>
                    <p id="rx-filesize" class="text-xs text-slate-500 font-mono">-- MB</p>
                </div>
                <div class="text-right">
                    <p id="rx-eta" class="text-sm font-mono font-bold text-indigo-600">--:--</p>
                </div>
            </div>
            <div class="h-2 bg-slate-100 rounded-full overflow-hidden mb-2">
                <div id="rx-bar" class="h-full bg-indigo-500 w-0 transition-all duration-300"></div>
            </div>
            <div class="flex justify-between items-center text-[10px] text-slate-500 font-mono font-bold">
                <span>è¿›åº¦: <span id="rx-pct">0</span>% (<span id="rx-count">0</span>/<span id="rx-total">0</span>)</span>
                <button onclick="receiver.reset()" class="bg-slate-100 text-slate-600 px-3 py-1 rounded">é‡ç½®</button>
            </div>
        </div>

        <div id="rx-complete-view" class="hidden text-center py-2">
            <div class="w-12 h-12 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-3 text-xl">âœ“</div>
            <h3 class="text-slate-800 font-bold mb-1">æ¥æ”¶å®Œæˆ</h3>
            <div class="flex gap-2">
                <button onclick="receiver.reset()" class="flex-1 py-3 bg-slate-100 text-slate-600 rounded-xl font-bold text-sm">å†è¯•ä¸€æ¬¡</button>
                <button id="btn-download" class="flex-[2] py-3 bg-indigo-600 text-white rounded-xl font-bold text-sm shadow-lg">ä¸‹è½½æ–‡ä»¶</button>
            </div>
        </div>
    </div>
</main>

<script>
// ================= å·¥å…·åº“ =================
const Utils = {
    formatSize: (b) => {
        if(!b) return '0 B';
        const k=1024, s=['B','KB','MB','GB'];
        const i=Math.floor(Math.log(b)/Math.log(k));
        return parseFloat((b/Math.pow(k,i)).toFixed(2))+' '+s[i];
    },
    formatTime: (sec) => {
        if(!isFinite(sec) || sec < 0) return "--:--";
        const m = Math.floor(sec / 60);
        const s = Math.floor(sec % 60);
        return `${m}:${s<10?'0':''}${s}`;
    },
    // å®‰å…¨äºŒè¿›åˆ¶è½¬Base64 (è§£å†³ä¸­æ–‡/æº¢å‡ºé—®é¢˜)
    arrToBase64: (arr) => {
        let binary = '';
        const len = arr.byteLength;
        for (let i = 0; i < len; i++) binary += String.fromCharCode(arr[i]);
        return btoa(binary);
    },
    base64ToArr: (b64) => {
        const binary = atob(b64);
        const len = binary.length;
        const bytes = new Uint8Array(len);
        for (let i = 0; i < len; i++) bytes[i] = binary.charCodeAt(i);
        return bytes;
    },
    PRNG: (seed) => {
        return () => {
            let t = seed += 0x6D2B79F5;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }
    }
};

// ================= APP æ§åˆ¶ =================
const app = {
    switchTab: (t) => {
        document.getElementById('panel-send').classList.toggle('hidden', t!=='send');
        document.getElementById('panel-receive').classList.toggle('hidden', t!=='receive');
        const btnS = document.getElementById('tab-s'), btnR = document.getElementById('tab-r');
        if(t==='send') {
            btnS.className = "px-4 py-1.5 rounded-md text-xs font-bold bg-white text-indigo-600 shadow-sm";
            btnR.className = "px-4 py-1.5 rounded-md text-xs font-bold text-slate-500";
            receiver.stop();
        } else {
            btnR.className = "px-4 py-1.5 rounded-md text-xs font-bold bg-white text-indigo-600 shadow-sm";
            btnS.className = "px-4 py-1.5 rounded-md text-xs font-bold text-slate-500";
            sender.stop();
        }
    }
};

// ================= å‘é€ç«¯é€»è¾‘ =================
const sender = {
    data: null,
    meta: { name: "", size: 0 },
    chunks: [],
    fps: 12,
    chunkSize: 180,
    timer: null,
    tid: null,
    packetCount: 0,
    qrs: [],
    
    init: () => {
        ['qr1','qr2','qr3','qr4'].forEach(id => {
            sender.qrs.push(new QRious({ element: document.getElementById(id), size: 280, level: 'L' }));
        });
    },

    toggleInputMode: (mode) => {
        document.getElementById('input-file-area').classList.toggle('hidden', mode !== 'file');
        document.getElementById('input-text-area').classList.toggle('hidden', mode !== 'text');
        sender.reset();
    },

    handleFile: (f) => {
        if(!f) return;
        sender.meta = { name: f.name, size: f.size };
        const r = new FileReader();
        r.onload = (e) => {
            sender.data = new Uint8Array(e.target.result);
            sender.prepareChunks();
        };
        r.readAsArrayBuffer(f);
    },

    handleText: () => {
        const txt = document.getElementById('textInput').value;
        if(!txt) return;
        sender.data = new TextEncoder().encode(txt);
        sender.meta = { name: "æ–‡æœ¬å†…å®¹.txt", size: sender.data.length };
        sender.prepareChunks();
    },

    prepareChunks: () => {
        document.getElementById('selected-info').classList.remove('hidden');
        document.getElementById('send-name').innerText = sender.meta.name;
        document.getElementById('send-size').innerText = Utils.formatSize(sender.meta.size);
        document.getElementById('btn-send-start').disabled = false;
        
        sender.chunks = [];
        const size = parseInt(sender.chunkSize);
        for(let i=0; i<sender.data.length; i+=size) {
            let blk = sender.data.slice(i, i+size);
            if(blk.length < size) {
                const tmp = new Uint8Array(size);
                tmp.set(blk);
                blk = tmp;
            }
            sender.chunks.push(blk);
        }
    },

    updateSettings: (key, val) => {
        sender[key] = parseInt(val);
        document.getElementById(`val-${key==='chunkSize'?'size':'fps'}`).innerText = val;
        if(sender.data) sender.prepareChunks();
        if(sender.timer) { sender.stop(); sender.start(); }
    },

    start: () => {
        if(!sender.chunks.length) return;
        // TID ä½¿ç”¨æ—¶é—´æˆ³+éšæœºï¼Œå¹¶ç¡®ä¿ç¼–ç å®‰å…¨
        sender.tid = Math.floor(Date.now() / 1000).toString(36);
        sender.packetCount = 0;
        document.getElementById('matrix-container').classList.remove('opacity-30', 'blur-[2px]');
        document.getElementById('send-overlay').classList.add('hidden');
        document.getElementById('send-controls').classList.remove('hidden');
        sender.timer = setInterval(sender.tick, 1000 / sender.fps);
    },

    stop: () => {
        clearInterval(sender.timer);
        sender.timer = null;
        document.getElementById('matrix-container').classList.add('opacity-30', 'blur-[2px]');
        document.getElementById('send-overlay').classList.remove('hidden');
        document.getElementById('send-controls').classList.add('hidden');
    },

    reset: () => {
        sender.stop();
        sender.data = null;
        sender.chunks = [];
        document.getElementById('fileInput').value = '';
        document.getElementById('textInput').value = '';
        document.getElementById('selected-info').classList.add('hidden');
        document.getElementById('btn-send-start').disabled = true;
    },
    tick: () => {
        const total = sender.chunks.length;
        const cSize = parseInt(sender.chunkSize);
        const safeName = btoa(encodeURIComponent(sender.meta.name));
        const metaStr = `${safeName}:${sender.meta.size}`;

        for(let i=0; i<4; i++) {
            sender.packetCount++;
            const seed = Math.floor(Math.random() * 1000000);
            const rand = Utils.PRNG(seed);
            
            // --- æ ¸å¿ƒä¿®å¤ï¼šç¡®ä¿åº¦(degree)æ°¸è¿œä¸ä¼šè¶…è¿‡æ€»å—æ•° ---
            let degree = 1;
            const r = rand();
            if (total <= 1) {
                degree = 1; 
            } else if (r < 0.4) {
                degree = 1;
            } else if (r < 0.7) {
                degree = Math.min(total, 2);
            } else {
                // éšæœºé€‰æ‹©åº¦ï¼Œä½†ä¸Šé™å¿…é¡»æ˜¯ total
                degree = Math.min(total, Math.ceil(rand() * 5) + 2);
            }

            const indices = [];
            // --- æ ¸å¿ƒä¿®å¤ï¼šé˜²æ­¢æ­»å¾ªç¯ ---
            if (degree >= total) {
                for(let j=0; j<total; j++) indices.push(j);
            } else {
                while(indices.length < degree) {
                    const idx = Math.floor(rand() * total);
                    if(!indices.includes(idx)) indices.push(idx);
                }
            }
            // --- ä¿®å¤ç»“æŸ ---

            const xored = new Uint8Array(cSize);
            indices.forEach(idx => {
                const blk = sender.chunks[idx];
                for(let b=0; b<cSize; b++) xored[b] ^= blk[b];
            });

            const b64Data = Utils.arrToBase64(xored);
            sender.qrs[i].value = `${sender.tid}|${seed}|${total}|${b64Data}|${metaStr}`;
        }
        document.getElementById('pkg-counter').innerText = sender.packetCount;
    }
    };

// ================= æ¥æ”¶ç«¯é€»è¾‘ =================
const receiver = {
    video: document.getElementById('rx-video'),
    canvas: document.getElementById('rx-canvas'),
    ctx: null,
    stream: null,
    scanning: false,
    
    tid: null,
    startTime: 0,
    totalBlocks: 0,
    fileName: "",
    fileSize: 0,
    collected: new Set(),
    solved: {},
    queue: [],

    init: () => {
        receiver.ctx = receiver.canvas.getContext('2d', { willReadFrequently: true });
    },

    setSource: async (type) => {
        receiver.stop();
        receiver.init();
        try {
            const constraints = type === 'screen' ? null : { video: { facingMode: type, width: 1280, height: 720 } };
            receiver.stream = type === 'screen' ? 
                await navigator.mediaDevices.getDisplayMedia({ video: true }) : 
                await navigator.mediaDevices.getUserMedia(constraints);
            receiver.video.srcObject = receiver.stream;
            receiver.startScan();
        } catch(e) {
            alert("å¼€å¯å¤±è´¥: " + e.message);
        }
    },

    startScan: () => {
        document.getElementById('rx-overlay').classList.add('hidden');
        receiver.scanning = true;
        requestAnimationFrame(receiver.loop);
    },

    stop: () => {
        receiver.scanning = false;
        if(receiver.stream) receiver.stream.getTracks().forEach(t => t.stop());
        receiver.stream = null;
        document.getElementById('rx-overlay').classList.remove('hidden');
    },

    reset: () => {
        receiver.tid = null;
        receiver.collected.clear();
        receiver.solved = {};
        receiver.queue = [];
        document.getElementById('rx-status-card').classList.add('hidden');
        document.getElementById('rx-complete-view').classList.add('hidden');
        document.getElementById('rx-progress-view').classList.remove('hidden');
        document.getElementById('rx-bar').style.width = '0%';
    },

    loop: () => {
        if(!receiver.scanning) return;
        if(receiver.video.readyState === receiver.video.HAVE_ENOUGH_DATA) {
            const w = receiver.video.videoWidth, h = receiver.video.videoHeight;
            receiver.canvas.width = w; receiver.canvas.height = h;
            receiver.ctx.drawImage(receiver.video, 0, 0, w, h);

            const midX = w/2, midY = h/2;
            const regions = [
                {id:'full', x:0, y:0, w:w, h:h},
                {id:'q-tl', x:0, y:0, w:midX, h:midY},
                {id:'q-tr', x:midX, y:0, w:midX, h:midY},
                {id:'q-bl', x:0, y:midY, w:midX, h:midY},
                {id:'q-br', x:midX, y:midY, w:midX, h:midY},
            ];

            regions.forEach(r => {
                const idata = receiver.ctx.getImageData(r.x, r.y, r.w, r.h);
                const code = jsQR(idata.data, r.w, r.h);
                if(code && code.data) {
                    const qEl = document.getElementById(r.id);
                    if(qEl) {
                        qEl.classList.add('active');
                        setTimeout(() => qEl.classList.remove('active'), 200);
                    }
                    receiver.parse(code.data);
                }
            });
        }
        requestAnimationFrame(receiver.loop);
    },

    parse: (str) => {
        const p = str.split('|');
        if(p.length < 5) return;
        const [tid, seedStr, totalStr, b64, metaStr] = p;
        const seed = parseInt(seedStr), total = parseInt(totalStr);

        if(receiver.tid !== tid) {
            receiver.tid = tid;
            receiver.totalBlocks = total;
            receiver.startTime = Date.now();
            const [safeName, fsize] = metaStr.split(':');
            try {
                receiver.fileName = decodeURIComponent(atob(safeName));
            } catch(e) { receiver.fileName = "unknown_file"; }
            receiver.fileSize = parseInt(fsize);
            receiver.collected.clear();
            receiver.solved = {};
            receiver.queue = [];
            
            document.getElementById('rx-status-card').classList.remove('hidden');
            document.getElementById('rx-filename').innerText = receiver.fileName;
            document.getElementById('rx-filesize').innerText = Utils.formatSize(receiver.fileSize);
            document.getElementById('rx-total').innerText = total;
        }

        if(receiver.collected.has(seed) || Object.keys(receiver.solved).length >= total) return;
        receiver.collected.add(seed);

        const data = Utils.base64ToArr(b64);
        const rand = Utils.PRNG(seed);
        let degree = 1;
        const r = rand();
        if(r < 0.4) degree = 1;
        else if(r < 0.7) degree = 2;
        else degree = Math.min(total, Math.ceil(rand() * 5) + 2);

        const indices = [];
        while(indices.length < degree) {
            const idx = Math.floor(rand() * total);
            if(!indices.includes(idx)) indices.push(idx);
        }

        receiver.queue.push({ indices, data });
        receiver.processQueue();
        receiver.updateStats();
    },

    processQueue: () => {
        let progress = true;
        while(progress) {
            progress = false;
            receiver.queue.forEach(item => {
                const needed = item.indices.filter(idx => !receiver.solved[idx]);
                if(needed.length < item.indices.length) {
                    const known = item.indices.filter(idx => receiver.solved[idx]);
                    known.forEach(idx => {
                        const val = receiver.solved[idx];
                        for(let i=0; i<item.data.length; i++) item.data[i] ^= val[i];
                    });
                    item.indices = needed;
                    progress = true;
                }
            });

            const solvableIdx = receiver.queue.findIndex(i => i.indices.length === 1);
            if(solvableIdx !== -1) {
                const solvable = receiver.queue.splice(solvableIdx, 1)[0];
                const realIdx = solvable.indices[0];
                if(!receiver.solved[realIdx]) {
                    receiver.solved[realIdx] = solvable.data;
                    progress = true;
                }
            }
        }
    },

    updateStats: () => {
        const solvedCount = Object.keys(receiver.solved).length;
        const pct = Math.floor((solvedCount / receiver.totalBlocks) * 100);
        document.getElementById('rx-bar').style.width = pct + '%';
        document.getElementById('rx-pct').innerText = pct;
        document.getElementById('rx-count').innerText = solvedCount;

        const elapsed = (Date.now() - receiver.startTime) / 1000;
        if(elapsed > 1 && solvedCount > 0) {
            const eta = ((receiver.totalBlocks - solvedCount) / (solvedCount / elapsed));
            document.getElementById('rx-eta').innerText = Utils.formatTime(eta);
        }

        if(solvedCount >= receiver.totalBlocks) receiver.finish();
    },

    finish: () => {
        receiver.scanning = false;
        document.getElementById('rx-progress-view').classList.add('hidden');
        document.getElementById('rx-complete-view').classList.remove('hidden');
        
        const chunks = [];
        for(let i=0; i<receiver.totalBlocks; i++) chunks.push(receiver.solved[i]);
        
        const totalLen = chunks.length * chunks[0].length;
        const fileData = new Uint8Array(totalLen);
        chunks.forEach((c, i) => fileData.set(c, i * c.length));

        const finalData = fileData.slice(0, receiver.fileSize);
        const blob = new Blob([finalData]);
        document.getElementById('btn-download').onclick = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = receiver.fileName;
            a.click();
        };
    }
};

sender.init();
</script>
</body>
</html>

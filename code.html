<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AirScan Pro | å…‰å­¦çŸ©é˜µä¼ è¾“</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        /* éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        .matrix-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: 1fr 1fr; 
            gap: 8px; 
            width: 100%; 
            aspect-ratio: 1/1;
            padding: 8px;
            background: #f8fafc;
            border-radius: 20px;
        }
        canvas.qr-cell { width: 100% !important; height: 100% !important; border-radius: 8px; image-rendering: pixelated; }
        
        /* æ‰«æé®ç½© */
        .scan-mask { position: absolute; inset: 0; pointer-events: none; border-radius: 16px; overflow: hidden;}
        .scan-quadrant { border: 1px dashed rgba(255,255,255,0.3); box-sizing: border-box; transition: all 0.2s; }
        .scan-quadrant.active { background: rgba(16, 185, 129, 0.3); border: 2px solid #10b981; }

        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #3b82f6; margin-top: -8px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #e2e8f0; border-radius: 2px; }

        dialog::backdrop { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen pb-safe">

<div class="max-w-md mx-auto min-h-screen flex flex-col bg-white shadow-2xl overflow-hidden relative">
    
    <header class="px-6 pt-8 pb-4 flex justify-between items-center bg-white sticky top-0 z-10 border-b border-slate-100">
        <div>
            <h1 class="text-xl font-black tracking-tight text-slate-900">AirScan <span class="text-blue-600">Pro</span></h1>
            <p class="text-[10px] text-slate-400 font-medium tracking-wide uppercase">Matrix Fountain Protocol</p>
        </div>
        <button onclick="document.getElementById('helpModal').showModal()" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center font-bold text-lg hover:bg-slate-200 transition">?</button>
    </header>

    <div class="px-6 py-2">
        <div class="flex bg-slate-100 p-1 rounded-2xl relative font-bold text-sm">
            <button onclick="app.switchTab('send')" id="tab-s" class="flex-1 py-2.5 rounded-xl shadow-sm bg-white text-blue-600 transition-all z-10">å‘é€æ–‡ä»¶</button>
            <button onclick="app.switchTab('receive')" id="tab-r" class="flex-1 py-2.5 rounded-xl text-slate-400 transition-all z-10">æ¥æ”¶æ–‡ä»¶</button>
        </div>
    </div>

    <main id="panel-send" class="flex-1 px-6 py-4 flex flex-col space-y-4 overflow-y-auto">
        
        <div class="bg-slate-50 border-2 border-dashed border-slate-200 rounded-3xl p-6 text-center transition hover:border-blue-400 group relative">
            <div id="empty-state">
                <div class="w-12 h-12 bg-blue-100 text-blue-600 rounded-2xl flex items-center justify-center mx-auto mb-3 text-2xl group-hover:scale-110 transition">ğŸ“‚</div>
                <h3 class="text-sm font-bold text-slate-700">ç‚¹å‡»é€‰æ‹©æˆ–æ‹–å…¥æ–‡ä»¶</h3>
                <p class="text-xs text-slate-400 mt-1">æ”¯æŒå›¾ç‰‡ã€æ–‡æ¡£ã€å‹ç¼©åŒ…</p>
            </div>
            
            <div id="file-state" class="hidden">
                <div class="flex items-center gap-3 text-left">
                    <div class="w-10 h-10 bg-blue-600 text-white rounded-xl flex items-center justify-center font-bold text-xs shadow-lg shadow-blue-200">FILE</div>
                    <div class="flex-1 min-w-0">
                        <p id="send-filename" class="text-sm font-bold text-slate-800 truncate">example.zip</p>
                        <p id="send-filesize" class="text-xs text-slate-500 font-mono">2.4 MB</p>
                    </div>
                    <button onclick="app.resetFile(event)" class="p-2 text-slate-300 hover:text-red-500 transition">âœ•</button>
                </div>
            </div>
            
            <input type="file" id="fileInput" class="absolute inset-0 opacity-0 cursor-pointer" onchange="sender.handleFile(this.files[0])">
        </div>

        <div class="bg-white border border-slate-100 rounded-2xl p-4 shadow-sm">
            <div class="flex justify-between items-center cursor-pointer" onclick="document.getElementById('adv-settings').classList.toggle('hidden')">
                <span class="text-xs font-bold text-slate-500 uppercase">ä¼ è¾“å‚æ•°é…ç½®</span>
                <span class="text-xs text-blue-500">ä¿®æ”¹ â–¼</span>
            </div>
            <div id="adv-settings" class="hidden mt-4 space-y-4 border-t border-slate-100 pt-4">
                <div>
                    <div class="flex justify-between text-xs mb-2">
                        <span class="text-slate-500">åˆ·æ–°ç‡ (FPS)</span>
                        <span id="disp-fps" class="font-mono font-bold text-slate-700">15</span>
                    </div>
                    <input type="range" min="5" max="30" value="15" oninput="sender.fps=this.value; document.getElementById('disp-fps').innerText=this.value; sender.restart()">
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-2">
                        <span class="text-slate-500">å•å¸§å®¹é‡ (Bytes)</span>
                        <span id="disp-size" class="font-mono font-bold text-slate-700">250</span>
                    </div>
                    <input type="range" min="100" max="600" step="10" value="250" oninput="sender.chunkSize=this.value; document.getElementById('disp-size').innerText=this.value; sender.prepareData()">
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col justify-center min-h-[300px] relative">
            <div id="matrix-container" class="matrix-grid opacity-50 blur-sm transition duration-500">
                <canvas id="qr1" class="qr-cell"></canvas>
                <canvas id="qr2" class="qr-cell"></canvas>
                <canvas id="qr3" class="qr-cell"></canvas>
                <canvas id="qr4" class="qr-cell"></canvas>
            </div>
            
            <div id="send-overlay" class="absolute inset-0 flex items-center justify-center">
                <button id="btn-start-send" onclick="sender.toggle()" disabled class="bg-slate-900 text-white px-8 py-3 rounded-2xl font-bold shadow-xl shadow-slate-200 disabled:opacity-50 disabled:cursor-not-allowed transform active:scale-95 transition">
                    å¼€å§‹å¹¿æ’­
                </button>
            </div>
        </div>
        
        <p class="text-center text-[10px] text-slate-400 font-mono">PACKETS SENT: <span id="pkg-count" class="text-slate-800">0</span></p>
    </main>

    <main id="panel-receive" class="hidden flex-1 px-6 py-4 flex flex-col space-y-4">
        <div class="bg-slate-900 rounded-[2rem] p-1 shadow-2xl relative aspect-[3/4] overflow-hidden">
            <video id="cam-video" class="hidden" autoplay playsinline></video>
            <canvas id="cam-canvas" class="w-full h-full object-cover rounded-[1.8rem] bg-slate-800"></canvas>
            
            <div class="scan-mask grid grid-cols-2 grid-rows-2">
                <div id="q-tl" class="scan-quadrant border-r border-b"></div>
                <div id="q-tr" class="scan-quadrant border-b"></div>
                <div id="q-bl" class="scan-quadrant border-r"></div>
                <div id="q-br" class="scan-quadrant"></div>
            </div>

            <div id="cam-overlay" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900/60 backdrop-blur-sm z-20">
                <button onclick="receiver.start()" class="bg-blue-600 text-white w-16 h-16 rounded-full flex items-center justify-center text-2xl shadow-lg shadow-blue-500/50 animate-pulse">ğŸ“·</button>
                <p class="text-white text-xs font-bold mt-4">ç‚¹å‡»å¼€å¯æ‘„åƒå¤´</p>
            </div>
        </div>

        <div class="bg-white border border-slate-100 rounded-3xl p-5 shadow-lg relative overflow-hidden">
            <div id="recv-idle" class="text-center py-2">
                <p class="text-sm font-bold text-slate-400">ç­‰å¾…ä¿¡å·...</p>
            </div>
            
            <div id="recv-active" class="hidden space-y-3">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-[10px] text-slate-400 font-bold uppercase mb-1">Incoming File</p>
                        <p id="recv-name" class="text-sm font-bold text-slate-800 break-all leading-tight">--</p>
                    </div>
                    <span id="recv-size" class="text-xs bg-slate-100 text-slate-600 px-2 py-1 rounded-lg font-mono font-bold">0 KB</span>
                </div>
                
                <div class="h-3 bg-slate-100 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full bg-gradient-to-r from-blue-500 to-indigo-500 w-0 transition-all duration-300"></div>
                </div>
                
                <div class="flex justify-between text-[10px] font-mono font-bold text-slate-400">
                    <span>PKGS: <span id="collected-count" class="text-blue-600">0</span></span>
                    <span id="progress-text">0%</span>
                </div>
            </div>

            <div id="recv-success" class="hidden absolute inset-0 bg-emerald-500 flex flex-col items-center justify-center text-white z-30">
                <div class="text-3xl mb-2">ğŸ‰</div>
                <p class="font-bold text-sm">æ¥æ”¶å®Œæˆ</p>
                <button id="dl-btn" class="mt-4 bg-white text-emerald-600 px-6 py-2 rounded-xl font-bold text-xs shadow-lg">ä¸‹è½½æ–‡ä»¶</button>
            </div>
        </div>
    </main>

    <dialog id="helpModal" class="p-0 rounded-3xl max-w-xs shadow-2xl backdrop:bg-slate-900/50">
        <div class="p-6 bg-white">
            <h3 class="text-lg font-black text-slate-800 mb-4">å¦‚ä½•ä½¿ç”¨ AirScan Pro</h3>
            <ul class="space-y-4 text-sm text-slate-600">
                <li class="flex gap-3">
                    <span class="bg-blue-100 text-blue-600 w-6 h-6 rounded-full flex-none flex items-center justify-center font-bold text-xs">1</span>
                    <p>åœ¨å‘é€ç«¯é€‰æ‹©æ–‡ä»¶ã€‚ç³»ç»Ÿä¼šå°†æ–‡ä»¶åˆ‡å‰²å¹¶é€šè¿‡ 4 ä¸ªäºŒç»´ç å¹¶è¡Œå¹¿æ’­ã€‚</p>
                </li>
                <li class="flex gap-3">
                    <span class="bg-blue-100 text-blue-600 w-6 h-6 rounded-full flex-none flex items-center justify-center font-bold text-xs">2</span>
                    <p>åœ¨æ¥æ”¶ç«¯æ‰“å¼€æ‘„åƒå¤´ï¼Œå¯¹å‡†å‘é€ç«¯çš„ 2x2 çŸ©é˜µã€‚</p>
                </li>
                <li class="flex gap-3">
                    <span class="bg-blue-100 text-blue-600 w-6 h-6 rounded-full flex-none flex items-center justify-center font-bold text-xs">3</span>
                    <p>åˆ©ç”¨<b>å–·æ³‰ç </b>æŠ€æœ¯ï¼Œæ— éœ€å¯¹é½æ¯ä¸€å¸§ã€‚åªè¦æ”¶é›†åˆ°è¶³å¤Ÿçš„æ•°æ®åŒ…ï¼Œæ–‡ä»¶å³å¯è¿˜åŸã€‚</p>
                </li>
            </ul>
            <form method="dialog" class="mt-6">
                <button class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold text-sm">æˆ‘çŸ¥é“äº†</button>
            </form>
        </div>
    </dialog>

</div>

<script>
// ================= UTILS =================
const Utils = {
    formatSize: (bytes) => {
        if (bytes === 0) return '0 B';
        const k = 1024, sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    },
    // ç®€æ˜“PRNGï¼Œä¿è¯æ”¶å‘ç«¯ä¸€è‡´
    PRNG: (seed) => () => {
        let t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
    }
};

// ================= APP STATE =================
const app = {
    activeTab: 'send',
    switchTab: (tab) => {
        app.activeTab = tab;
        ['send', 'receive'].forEach(t => {
            const active = t === tab;
            document.getElementById(`panel-${t}`).classList.toggle('hidden', !active);
            const btn = document.getElementById(`tab-${t[0]}`);
            if(active) {
                btn.className = 'flex-1 py-2.5 rounded-xl shadow-sm bg-white text-blue-600 transition-all z-10';
            } else {
                btn.className = 'flex-1 py-2.5 rounded-xl text-slate-400 transition-all z-10';
            }
        });
        if (tab === 'receive') {
            sender.stop();
        } else {
            receiver.stop();
        }
    },
    resetFile: (e) => {
        if(e) e.stopPropagation();
        document.getElementById('fileInput').value = '';
        document.getElementById('empty-state').classList.remove('hidden');
        document.getElementById('file-state').classList.add('hidden');
        document.getElementById('btn-start-send').disabled = true;
        document.getElementById('matrix-container').classList.add('opacity-50', 'blur-sm');
        document.getElementById('send-overlay').classList.remove('hidden');
        document.getElementById('btn-start-send').innerText = "å¼€å§‹å¹¿æ’­";
        sender.stop();
    }
};

// ================= SENDER ENGINE =================
const sender = {
    fileBytes: null,
    fileName: "",
    fileSize: 0,
    chunks: [],
    
    // Settings
    fps: 15,
    chunkSize: 250,
    
    // Runtime
    timer: null,
    tid: null,
    packetCount: 0,
    qrs: [],
    isSending: false,

    init: () => {
        ['qr1','qr2','qr3','qr4'].forEach(id => {
            sender.qrs.push(new QRious({ element: document.getElementById(id), size: 300, level: 'L' }));
        });
    },

    handleFile: (file) => {
        if (!file) return;
        sender.fileName = file.name;
        sender.fileSize = file.size;
        
        // UI update
        document.getElementById('send-filename').innerText = file.name;
        document.getElementById('send-filesize').innerText = Utils.formatSize(file.size);
        document.getElementById('empty-state').classList.add('hidden');
        document.getElementById('file-state').classList.remove('hidden');
        
        // Read
        const r = new FileReader();
        r.onload = (e) => {
            sender.fileBytes = new Uint8Array(e.target.result);
            sender.prepareData();
            document.getElementById('btn-start-send').disabled = false;
        };
        r.readAsArrayBuffer(file);
    },

    prepareData: () => {
        if (!sender.fileBytes) return;
        sender.chunks = [];
        const total = sender.fileBytes.length;
        const size = parseInt(sender.chunkSize);
        
        for (let i = 0; i < total; i += size) {
            let chunk = sender.fileBytes.slice(i, i + size);
            // Padding if needed (simplified for robustness: just send as is, receiver handles logic)
            // But for XOR to work easily, uniform size is better.
            if (chunk.length < size) {
                const temp = new Uint8Array(size);
                temp.set(chunk);
                chunk = temp;
            }
            sender.chunks.push(chunk);
        }
    },

    toggle: () => {
        if (sender.isSending) {
            sender.stop();
            document.getElementById('btn-start-send').innerText = "ç»§ç»­å¹¿æ’­";
            document.getElementById('matrix-container').classList.add('opacity-50', 'blur-sm');
            document.getElementById('send-overlay').classList.remove('hidden');
        } else {
            sender.start();
        }
    },

    start: () => {
        if (!sender.chunks.length) return;
        sender.isSending = true;
        sender.tid = Math.floor(Math.random() * 999).toString(36); // Short TID
        document.getElementById('matrix-container').classList.remove('opacity-50', 'blur-sm');
        document.getElementById('send-overlay').classList.add('hidden');
        sender.timer = setInterval(sender.tick, 1000 / sender.fps);
    },

    restart: () => {
        if (sender.isSending) {
            clearInterval(sender.timer);
            sender.timer = setInterval(sender.tick, 1000 / sender.fps);
        }
    },

    stop: () => {
        sender.isSending = false;
        clearInterval(sender.timer);
    },

    tick: () => {
        // Update all 4 QRs
        for(let i=0; i<4; i++) {
            sender.packetCount++;
            const seed = Math.floor(Math.random() * 2000000);
            
            // LT Code Logic: Determine degree and neighbors
            const total = sender.chunks.length;
            const rand = Utils.PRNG(seed);
            let degree = 1;
            const r = rand();
            // Soliton distribution simplified
            if (r < 0.5) degree = 1;
            else if (r < 0.8) degree = 2;
            else degree = Math.min(total, Math.ceil(rand() * 5) + 2);

            const indices = [];
            while(indices.length < degree) {
                const idx = Math.floor(rand() * total);
                if(!indices.includes(idx)) indices.push(idx);
            }

            // XOR
            const dataLen = parseInt(sender.chunkSize);
            const xored = new Uint8Array(dataLen);
            indices.forEach((idx, n) => {
                const blk = sender.chunks[idx];
                for(let b=0; b<dataLen; b++) xored[b] ^= blk[b];
            });

            // Convert to Base64
            let binary = '';
            const len = xored.byteLength;
            for (let b = 0; b < len; b++) binary += String.fromCharCode(xored[b]);
            const b64 = btoa(binary);

            // Protocol: TID | Seed | TotalChunks | Data | Meta(Name:Size)
            // Including meta in every packet is overhead but ensures instant UX.
            // To save space, we put Name:Size at the end.
            const meta = `${sender.fileName}:${sender.fileSize}`;
            const payload = `${sender.tid}|${seed}|${total}|${b64}|${meta}`;
            
            sender.qrs[i].value = payload;
        }
        document.getElementById('pkg-count').innerText = sender.packetCount;
    }
};

// ================= RECEIVER ENGINE =================
const receiver = {
    video: document.getElementById('cam-video'),
    canvas: document.getElementById('cam-canvas'),
    ctx: null,
    stream: null,
    scanning: false,
    
    // Data State
    tid: null,
    totalBlocks: 0,
    fileSize: 0,
    fileName: '',
    collected: new Set(),
    solved: {},
    queue: [],

    init: () => {
        receiver.ctx = receiver.canvas.getContext('2d', { willReadFrequently: true });
    },

    start: async () => {
        try {
            receiver.init();
            receiver.stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            receiver.video.srcObject = receiver.stream;
            document.getElementById('cam-overlay').classList.add('hidden');
            receiver.scanning = true;
            requestAnimationFrame(receiver.loop);
        } catch (e) {
            alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿æˆæƒã€‚');
        }
    },

    stop: () => {
        receiver.scanning = false;
        if (receiver.stream) receiver.stream.getTracks().forEach(t => t.stop());
        document.getElementById('cam-overlay').classList.remove('hidden');
    },

    loop: () => {
        if (!receiver.scanning) return;
        
        if (receiver.video.readyState === receiver.video.HAVE_ENOUGH_DATA) {
            const W = receiver.video.videoWidth;
            const H = receiver.video.videoHeight;
            receiver.canvas.width = W;
            receiver.canvas.height = H;
            receiver.ctx.drawImage(receiver.video, 0, 0, W, H);
            
            // Define 5 regions: Full, TL, TR, BL, BR
            const midX = W/2, midY = H/2;
            const regions = [
                { id: 'full', x: 0, y: 0, w: W, h: H },
                { id: 'q-tl', x: 0, y: 0, w: midX, h: midY },
                { id: 'q-tr', x: midX, y: 0, w: midX, h: midY },
                { id: 'q-bl', x: 0, y: midY, w: midX, h: midY },
                { id: 'q-br', x: midX, y: midY, w: midX, h: midY }
            ];

            // Reset visual feedback
            document.querySelectorAll('.scan-quadrant').forEach(el => el.classList.remove('active'));

            regions.forEach(r => {
                const imgData = receiver.ctx.getImageData(r.x, r.y, r.w, r.h);
                // jsQR scan
                const code = jsQR(imgData.data, r.w, r.h, { inversionAttempts: "dontInvert" });
                
                if (code) {
                    // Visual feedback
                    if (r.id !== 'full') {
                        document.getElementById(r.id).classList.add('active');
                    }
                    receiver.parse(code.data);
                }
            });
        }
        requestAnimationFrame(receiver.loop);
    },

    parse: (str) => {
        // Protocol: TID | Seed | Total | B64 | Meta
        const p = str.split('|');
        if (p.length < 5) return;

        const tid = p[0];
        const seed = parseInt(p[1]);
        const total = parseInt(p[2]);
        const b64 = p[3];
        const meta = p.slice(4).join('|'); // Join back in case filename has |

        // Reset if new file
        if (receiver.tid !== tid) {
            receiver.tid = tid;
            receiver.totalBlocks = total;
            const [fname, fsize] = meta.split(':');
            receiver.fileName = fname;
            receiver.fileSize = parseInt(fsize);
            
            // Reset logic
            receiver.collected.clear();
            receiver.solved = {};
            receiver.queue = [];
            
            // UI Update
            document.getElementById('recv-idle').classList.add('hidden');
            document.getElementById('recv-active').classList.remove('hidden');
            document.getElementById('recv-name').innerText = fname;
            document.getElementById('recv-size').innerText = Utils.formatSize(receiver.fileSize);
            document.getElementById('recv-success').classList.add('hidden');
        }

        if (receiver.collected.has(seed)) return;
        receiver.collected.add(seed);

        // UI progress update
        document.getElementById('collected-count').innerText = receiver.collected.size;
        
        // Decode
        const bin = atob(b64);
        const data = new Uint8Array(bin.length);
        for(let i=0; i<bin.length; i++) data[i] = bin.charCodeAt(i);

        // Reconstruct indices
        const rand = Utils.PRNG(seed);
        let degree = 1;
        const r = rand();
        if (r < 0.5) degree = 1;
        else if (r < 0.8) degree = 2;
        else degree = Math.min(total, Math.ceil(rand() * 5) + 2);

        const indices = [];
        while(indices.length < degree) {
            const idx = Math.floor(rand() * total);
            if(!indices.includes(idx)) indices.push(idx);
        }

        receiver.queue.push({ indices, data });
        receiver.solve();
    },

    solve: () => {
        let progress = true;
        while(progress) {
            progress = false;
            // Remove solved blocks from queue items
            receiver.queue.forEach(item => {
                const needed = item.indices.filter(idx => !receiver.solved[idx]);
                if (needed.length < item.indices.length) {
                    // XOR out known blocks
                    item.indices.forEach(idx => {
                        if (receiver.solved[idx]) {
                            const known = receiver.solved[idx];
                            for(let i=0; i<item.data.length; i++) item.data[i] ^= known[i];
                        }
                    });
                    item.indices = needed;
                    progress = true; // Changes happened
                }
            });

            // Find degree-1 blocks
            const solvable = receiver.queue.find(item => item.indices.length === 1);
            if (solvable) {
                const idx = solvable.indices[0];
                if (!receiver.solved[idx]) {
                    receiver.solved[idx] = solvable.data;
                    progress = true;
                    receiver.updateProgress();
                }
                // Cleanup
                receiver.queue = receiver.queue.filter(i => i.indices.length > 0);
            }
        }
    },

    updateProgress: () => {
        const done = Object.keys(receiver.solved).length;
        const pct = Math.floor((done / receiver.totalBlocks) * 100);
        document.getElementById('progress-bar').style.width = pct + '%';
        document.getElementById('progress-text').innerText = pct + '%';

        if (done >= receiver.totalBlocks) {
            receiver.finish();
        }
    },

    finish: () => {
        receiver.scanning = false;
        document.getElementById('recv-success').classList.remove('hidden');
        
        // Reassemble
        const chunks = [];
        for(let i=0; i<receiver.totalBlocks; i++) chunks.push(receiver.solved[i]);
        
        // Merge
        const totalLen = chunks.reduce((acc, c) => acc + c.length, 0);
        const fileData = new Uint8Array(totalLen);
        let offset = 0;
        chunks.forEach(c => {
            fileData.set(c, offset);
            offset += c.length;
        });

        // Slice to exact size (remove padding)
        const finalData = fileData.slice(0, receiver.fileSize);
        const blob = new Blob([finalData]);
        
        document.getElementById('dl-btn').onclick = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = receiver.fileName;
            a.click();
        };
    }
};

// Start
sender.init();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AirScan Matrix (å–·æ³‰ç æé€Ÿç‰ˆ)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        .grid-canvas-container { display: grid; gap: 4px; background: #eee; padding: 4px; border-radius: 12px; margin: 0 auto; width: fit-content;}
        canvas.qr-cell { width: 100%; height: auto; display: block; image-rendering: pixelated; }
        .scan-overlay { position: absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; border: 2px solid rgba(255,255,255,0.3); box-sizing: border-box;}
        .scan-grid-cell { border: 1px dashed rgba(255,255,255,0.2); position: relative; }
        .scan-grid-cell.active { border: 2px solid #10b981; background: rgba(16, 185, 129, 0.2); }
        /* éšè—åŸç”ŸVideoï¼Œæˆ‘ä»¬ç”»åœ¨Canvasä¸Šå¤„ç† */
        #video-hidden { display: none; }
    </style>
</head>
<body class="bg-slate-900 text-slate-100 min-h-screen pb-20">

<div class="max-w-xl mx-auto px-4 pt-6">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h1 class="text-2xl font-black bg-gradient-to-r from-blue-400 to-purple-400 bg-clip-text text-transparent">AirScan Matrix</h1>
            <p class="text-xs text-slate-400">å–·æ³‰ç  + çŸ©é˜µå¹¶è¡Œä¼ è¾“</p>
        </div>
        <div class="bg-slate-800 p-1 rounded-xl flex text-xs font-bold">
            <button id="tab-s" onclick="app.switchTab('send')" class="px-4 py-2 rounded-lg bg-slate-700 text-blue-300 shadow transition-all">å‘é€</button>
            <button id="tab-r" onclick="app.switchTab('receive')" class="px-4 py-2 rounded-lg text-slate-500 hover:text-slate-300 transition-all">æ¥æ”¶</button>
        </div>
    </div>

    <div id="panel-send" class="space-y-5">
        <div class="bg-slate-800 p-5 rounded-3xl border border-slate-700">
            <textarea id="inputText" class="w-full bg-slate-900/50 text-slate-200 p-3 rounded-xl border border-slate-700 text-sm h-24 focus:border-blue-500 outline-none" placeholder="è¾“å…¥æ–‡æœ¬æˆ–æ‹–å…¥æ–‡ä»¶..."></textarea>
            
            <div id="fileInfo" class="hidden mt-3 bg-blue-900/30 border border-blue-500/30 p-2 rounded-lg flex justify-between items-center">
                <span id="fileName" class="text-xs text-blue-300 truncate max-w-[200px]"></span>
                <button onclick="app.clearFile()" class="text-xs text-red-400 font-bold px-2">âœ•</button>
            </div>

            <div class="flex gap-3 mt-4">
                <button onclick="document.getElementById('fileInput').click()" class="flex-1 py-3 bg-slate-700 hover:bg-slate-600 rounded-xl font-bold text-sm transition">ğŸ“ é€‰æ‹©æ–‡ä»¶</button>
                <input type="file" id="fileInput" class="hidden">
                <button onclick="sender.init()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold text-sm shadow-lg shadow-blue-900/50 transition">ğŸš€ ç”ŸæˆçŸ©é˜µ</button>
            </div>
        </div>

        <div id="matrixControl" class="hidden bg-slate-800 p-5 rounded-3xl border border-slate-700 animate-fade-in">
            <div class="flex justify-between items-center mb-4">
                <span class="text-sm font-bold text-slate-400">çŸ©é˜µå¯†åº¦: <span id="gridVal" class="text-blue-400">2x2</span></span>
                <input type="range" min="1" max="3" value="2" class="w-32 accent-blue-500" oninput="sender.updateGridSize(this.value)">
            </div>
            
            <div class="flex justify-center bg-white p-4 rounded-2xl shadow-inner">
                <div id="qrGrid" class="grid-canvas-container" style="grid-template-columns: repeat(2, 1fr);">
                    </div>
            </div>

            <div class="mt-6 text-center">
                <p class="text-[10px] text-slate-500 uppercase tracking-widest mb-1">Fountain Code Status</p>
                <div class="text-2xl font-mono font-black text-emerald-400 tracking-tighter">
                    <span id="sentPackets">0</span> <span class="text-sm text-slate-600">Droplets</span>
                </div>
                <div class="text-xs text-slate-500 mt-2">æ­£åœ¨æ— é™ç”Ÿæˆéšæœºå¼‚æˆ–åŒ…...</div>
            </div>
        </div>
    </div>

    <div id="panel-receive" class="hidden space-y-5">
        <div class="bg-slate-800 p-4 rounded-3xl border border-slate-700 relative overflow-hidden">
            <div class="relative w-full aspect-[3/4] bg-black rounded-2xl overflow-hidden shadow-2xl">
                <video id="video-hidden" autoplay playsinline></video>
                <canvas id="scan-canvas" class="w-full h-full object-cover"></canvas>
                <div id="grid-overlay" class="absolute inset-0 grid grid-cols-2 grid-rows-2"></div>
            </div>

            <div class="mt-4 flex gap-3">
                <button id="btn-cam" onclick="receiver.toggleCamera()" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold text-sm shadow-lg shadow-emerald-900/50">å¼€å¯æ‘„åƒå¤´</button>
                <select id="cam-select" class="bg-slate-900 text-white text-xs px-2 rounded-xl border border-slate-600 outline-none max-w-[100px]">
                    <option value="environment">åç½®</option>
                    <option value="user">å‰ç½®</option>
                </select>
            </div>
        </div>

        <div id="recv-status" class="bg-slate-800 p-5 rounded-3xl border border-slate-700 hidden">
            <div class="flex justify-between text-xs font-bold text-slate-400 mb-2">
                <span>è§£ç è¿›åº¦ (Peeling Decoder)</span>
                <span id="progress-txt" class="text-blue-400">0%</span>
            </div>
            <div class="h-4 bg-slate-900 rounded-full overflow-hidden mb-4 border border-slate-700">
                <div id="progress-bar" class="h-full bg-gradient-to-r from-blue-500 to-purple-500 w-0 transition-all duration-300"></div>
            </div>
            
            <div class="grid grid-cols-2 gap-2 text-center">
                <div class="bg-slate-900/50 p-2 rounded-lg">
                    <div class="text-[10px] text-slate-500">å·²æ”¶é›†åŒ…</div>
                    <div id="stat-collected" class="font-mono text-lg text-slate-200">0</div>
                </div>
                <div class="bg-slate-900/50 p-2 rounded-lg">
                    <div class="text-[10px] text-slate-500">åŸå§‹å—æ€»æ•°</div>
                    <div id="stat-total" class="font-mono text-lg text-slate-200">-</div>
                </div>
            </div>

            <div id="download-area" class="hidden mt-4 pt-4 border-t border-slate-700 text-center">
                <p class="text-emerald-400 font-bold mb-2">ğŸ‰ æ–‡ä»¶è¿˜åŸæˆåŠŸ!</p>
                <button id="dl-btn" class="w-full py-3 bg-white text-slate-900 rounded-xl font-bold shadow-lg">ä¸‹è½½æ–‡ä»¶</button>
            </div>
        </div>
    </div>
</div>

<script>
// ==========================================
// 1. æ•°å­¦æ ¸å¿ƒï¼šLT å–·æ³‰ç  (ç®€åŒ–ç‰ˆ)
// ==========================================
class LTCodec {
    // ç®€å•çš„ä¼ªéšæœºæ•°ç”Ÿæˆå™¨ (ä¿è¯å‘é€/æ¥æ”¶ç«¯ä¸€è‡´)
    static PRNG(seed) {
        return function() {
            var t = seed += 0x6D2B79F5;
            t = Math.imul(t ^ t >>> 15, t | 1);
            t ^= t + Math.imul(t ^ t >>> 7, t | 61);
            return ((t ^ t >>> 14) >>> 0) / 4294967296;
        }
    }

    // ç”Ÿæˆä¸€ä¸ªç”¨äºå¼‚æˆ–çš„â€œåº¦â€å’Œâ€œå—ç´¢å¼•åˆ—è¡¨â€
    static getDropletSpecs(seed, totalBlocks) {
        const rand = this.PRNG(seed);
        // ç®€åŒ–çš„é²æ£’å­¤ç«‹å­åˆ†å¸ƒ (Robust Soliton) æ¨¡æ‹Ÿ
        // å¤§éƒ¨åˆ†æ˜¯åº¦1 (ç›´æ¥ä¼ è¾“)ï¼Œå°‘éƒ¨åˆ†æ˜¯é«˜ç»´åº¦ (ç”¨äºä¿®å¤)
        const r = rand();
        let degree = 1;
        if (r < 0.5) degree = 1;
        else if (r < 0.8) degree = 2;
        else if (r < 0.95) degree = Math.min(totalBlocks, 3 + Math.floor(rand() * 4));
        else degree = Math.min(totalBlocks, Math.ceil(rand() * totalBlocks)); // å…¨å±€ä¿®å¤åŒ…

        // éšæœºé€‰æ‹© degree ä¸ªä¸é‡å¤çš„å—ç´¢å¼•
        const indices = new Set();
        while(indices.size < degree) {
            indices.add(Math.floor(rand() * totalBlocks));
        }
        return Array.from(indices);
    }

    static xorChunks(chunks) {
        const len = chunks[0].length;
        const res = new Uint8Array(len);
        for(let i=0; i<len; i++) {
            let val = 0;
            for(let c of chunks) val ^= c[i];
            res[i] = val;
        }
        return res;
    }
}

// ==========================================
// 2. å…¨å±€çŠ¶æ€ç®¡ç†
// ==========================================
const app = {
    fileData: null,
    fileName: '',
    chunkSize: 150, // å‡å°å•ä¸ªäºŒç»´ç æ•°æ®é‡ä»¥æé«˜è¯†åˆ«ç‡
    switchTab: (t) => {
        ['send', 'receive'].forEach(m => {
            const isActive = m === t;
            document.getElementById(`panel-${m}`).classList.toggle('hidden', !isActive);
            const btn = document.getElementById(`tab-${m[0]}`);
            btn.className = isActive 
                ? 'px-4 py-2 rounded-lg bg-slate-700 text-blue-300 shadow transition-all'
                : 'px-4 py-2 rounded-lg text-slate-500 hover:text-slate-300 transition-all';
        });
        if(t === 'receive') receiver.initCanvas();
    },
    clearFile: () => {
        app.fileData = null;
        app.fileName = '';
        document.getElementById('inputText').value = '';
        document.getElementById('fileInfo').classList.add('hidden');
        document.getElementById('fileInput').value = '';
        document.getElementById('matrixControl').classList.add('hidden');
        sender.stop();
    }
};

// ==========================================
// 3. å‘é€ç«¯é€»è¾‘ (å–·æ³‰å‘ç”Ÿå™¨)
// ==========================================
const sender = {
    timer: null,
    gridSize: 2,
    blocks: [],
    packetCount: 0,
    tid: null, // ä¼ è¾“IDï¼Œç”¨äºåŒºåˆ†ä¸åŒæ–‡ä»¶

    init: () => {
        const text = document.getElementById('inputText').value;
        if (!app.fileData && !text) return alert("è¯·å…ˆè¾“å…¥å†…å®¹æˆ–é€‰æ‹©æ–‡ä»¶");
        
        // å‡†å¤‡æ•°æ®
        let u8;
        if (app.fileData) u8 = new Uint8Array(app.fileData);
        else u8 = new TextEncoder().encode(text);
        
        app.fileName = app.fileName || "text_clip.txt";
        
        // åˆ‡åˆ†åŸå§‹å—
        sender.blocks = [];
        for (let i = 0; i < u8.length; i += app.chunkSize) {
            // è¡¥é½æœ€åä¸€ä¸ªå—
            let chunk = u8.slice(i, i + app.chunkSize);
            if(chunk.length < app.chunkSize) {
                const pad = new Uint8Array(app.chunkSize);
                pad.set(chunk);
                chunk = pad;
            }
            sender.blocks.push(chunk);
        }

        sender.tid = Math.floor(Math.random() * 900 + 100); // 3ä½éšæœºID
        sender.packetCount = 0;
        
        document.getElementById('matrixControl').classList.remove('hidden');
        sender.renderGridStructure();
        sender.start();
    },

    updateGridSize: (val) => {
        sender.gridSize = parseInt(val);
        document.getElementById('gridVal').innerText = `${val}x${val}`;
        sender.renderGridStructure();
    },

    renderGridStructure: () => {
        const container = document.getElementById('qrGrid');
        container.style.gridTemplateColumns = `repeat(${sender.gridSize}, 1fr)`;
        container.innerHTML = '';
        sender.qrs = [];
        for(let i=0; i<sender.gridSize*sender.gridSize; i++) {
            const cvs = document.createElement('canvas');
            cvs.className = 'qr-cell bg-white rounded-lg';
            container.appendChild(cvs);
            sender.qrs.push(new QRious({ element: cvs, size: 200, level: 'L' })); // Lçº§åˆ«çº é”™å³å¯ï¼Œé å–·æ³‰ç çº é”™
        }
    },

    start: () => {
        if(sender.timer) clearInterval(sender.timer);
        sender.timer = setInterval(sender.tick, 100); // 10 FPS åˆ·æ–°ç‡
    },
    
    stop: () => {
        if(sender.timer) clearInterval(sender.timer);
    },

    tick: () => {
        // ä¸ºç½‘æ ¼ä¸­çš„æ¯ä¸€ä¸ªäºŒç»´ç ç”Ÿæˆä¸€ä¸ªæ–°çš„å–·æ³‰åŒ…
        sender.qrs.forEach(qr => {
            sender.packetCount++;
            // åè®®: TID(3) | Seed(6) | TotalBlocks(4) | Data...
            // Seed é‡‡ç”¨ç®€å•çš„è‡ªå¢æˆ–éšæœºï¼Œè¿™é‡Œç”¨éšæœºæ•°ç®€åŒ–
            const seed = Math.floor(Math.random() * 1000000);
            const indices = LTCodec.getDropletSpecs(seed, sender.blocks.length);
            
            // æ‰§è¡Œå¼‚æˆ–
            const selectedBlocks = indices.map(idx => sender.blocks[idx]);
            const xoredData = LTCodec.xorChunks(selectedBlocks);
            
            // ç»„è£… Payload (ä½¿ç”¨ Base64 ä»¥ä¾¿æ”¾å…¥äºŒç»´ç )
            // æ ¼å¼: tid|seed|total|base64_data
            // ä¼˜åŒ–: äºŒè¿›åˆ¶æ‹¼æ¥ä¼šæ›´çœç©ºé—´ï¼Œä½† JS æ¼”ç¤ºç”¨å­—ç¬¦ä¸²æ›´æ˜“è¯»
            const b64Data = btoa(String.fromCharCode(...xoredData));
            const payload = `${sender.tid}|${seed}|${sender.blocks.length}|${b64Data}|${app.fileName}`;
            
            qr.value = payload;
        });
        document.getElementById('sentPackets').innerText = sender.packetCount;
    }
};

// ==========================================
// 4. æ¥æ”¶ç«¯é€»è¾‘ (çŸ©é˜µå¹¶è¡Œè¯†åˆ« + å‰¥æ´‹è‘±è§£ç )
// ==========================================
const receiver = {
    video: document.getElementById('video-hidden'),
    canvas: document.getElementById('scan-canvas'),
    ctx: null,
    scanning: false,
    tid: null,
    totalBlocks: 0,
    collectedPackets: new Set(), // å­˜å·²æ”¶åˆ°çš„ Seedï¼Œé˜²é‡
    solvedBlocks: {}, // å·²è§£å‡ºçš„åŸå§‹å— { index: Uint8Array }
    dropletQueue: [], // å¾…å¤„ç†çš„å¼‚æˆ–å— [{seed, indices, data}]
    fileName: "",

    initCanvas: () => {
        receiver.ctx = receiver.canvas.getContext('2d', { willReadFrequently: true });
    },

    toggleCamera: async () => {
        if(receiver.scanning) {
            receiver.scanning = false;
            receiver.video.srcObject.getTracks().forEach(t => t.stop());
            document.getElementById('btn-cam').innerText = "å¼€å¯æ‘„åƒå¤´";
            document.getElementById('btn-cam').classList.replace('bg-red-600', 'bg-emerald-600');
            return;
        }

        try {
            const facing = document.getElementById('cam-select').value;
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: facing } });
            receiver.video.srcObject = stream;
            receiver.video.play();
            receiver.scanning = true;
            document.getElementById('btn-cam').innerText = "åœæ­¢æ‰«æ";
            document.getElementById('btn-cam').classList.replace('bg-emerald-600', 'bg-red-600');
            requestAnimationFrame(receiver.scanLoop);
            document.getElementById('recv-status').classList.remove('hidden');
        } catch (e) {
            alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + e.message);
        }
    },

    scanLoop: () => {
        if(!receiver.scanning) return;
        if(receiver.video.readyState === receiver.video.HAVE_ENOUGH_DATA) {
            const vid = receiver.video;
            const cvs = receiver.canvas;
            cvs.width = vid.videoWidth;
            cvs.height = vid.videoHeight;
            receiver.ctx.drawImage(vid, 0, 0, cvs.width, cvs.height);

            // åŠ¨æ€åˆ‡å‰²æ‰«æ
            // ç­–ç•¥ï¼šå‡è®¾å‘é€ç«¯å¯èƒ½æ˜¯ 1x1, 2x2, 3x3ã€‚
            // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åœ¨æ¥æ”¶ç«¯æŠŠç”»é¢åˆ‡æˆ 2x2 å’Œ 3x3 ä¸¤ä¸ªæ¨¡å¼å°è¯•æ‰«æï¼Œæˆ–è€…å…¨å±æ‰«æ
            // ä¸ºäº†æ€§èƒ½ï¼Œæˆ‘ä»¬è¿™é‡Œé‡‡ç”¨ä¸€ç§"æ»‘åŠ¨çª—å£"æˆ–è€…ç®€å•çš„"å››åˆ†æ ¼"ç­–ç•¥ã€‚
            
            // æ–¹æ¡ˆï¼šå°†ç”»é¢åˆ†ä¸º 2x2 åŒºåŸŸï¼Œåˆ†åˆ«é€å…¥ jsQR
            const w = cvs.width;
            const h = cvs.height;
            const halfW = w / 2;
            const halfH = h / 2;
            
            // å®šä¹‰æ‰«æåŒºåŸŸ (x, y, w, h, id)
            // åŒ…å«å…¨å± + 4ä¸ªè±¡é™ï¼Œç¡®ä¿å…¼å®¹å•ç å’ŒçŸ©é˜µç 
            const regions = [
                {x:0, y:0, w:w, h:h, id:'full'},
                {x:0, y:0, w:halfW, h:halfH, id:'tl'},
                {x:halfW, y:0, w:halfW, h:halfH, id:'tr'},
                {x:0, y:halfH, w:halfW, h:halfH, id:'bl'},
                {x:halfW, y:halfH, w:halfW, h:halfH, id:'br'}
            ];

            const overlay = document.getElementById('grid-overlay');
            overlay.innerHTML = ''; // æ¸…ç©ºä¸Šä¸€å¸§çš„åé¦ˆ

            regions.forEach(r => {
                const imgData = receiver.ctx.getImageData(r.x, r.y, r.w, r.h);
                const code = jsQR(imgData.data, r.w, r.h, { inversionAttempts: "dontInvert" });
                
                if(code && code.data) {
                    // è§†è§‰åé¦ˆï¼šåœ¨å¯¹åº”åŒºåŸŸç”»æ¡†
                    const cell = document.createElement('div');
                    cell.className = 'scan-grid-cell active';
                    cell.style.position = 'absolute';
                    cell.style.left = (r.x/w*100)+'%';
                    cell.style.top = (r.y/h*100)+'%';
                    cell.style.width = (r.w/w*100)+'%';
                    cell.style.height = (r.h/h*100)+'%';
                    overlay.appendChild(cell);

                    receiver.processPacket(code.data);
                }
            });
        }
        requestAnimationFrame(receiver.scanLoop);
    },

    processPacket: (str) => {
        // æ ¼å¼: tid|seed|total|base64_data|filename
        const p = str.split('|');
        if(p.length < 5) return;
        
        const tid = p[0];
        const seed = parseInt(p[1]);
        const total = parseInt(p[2]);
        const b64 = p[3];
        const fname = p[4];

        // æ–°ä»»åŠ¡é‡ç½®
        if(receiver.tid !== tid) {
            receiver.tid = tid;
            receiver.totalBlocks = total;
            receiver.fileName = fname;
            receiver.collectedPackets.clear();
            receiver.solvedBlocks = {};
            receiver.dropletQueue = [];
            document.getElementById('stat-total').innerText = total;
            document.getElementById('progress-bar').style.width = '0%';
            document.getElementById('download-area').classList.add('hidden');
        }

        if(receiver.collectedPackets.has(seed)) return; // å·²å¤„ç†è¿‡è¯¥åŒ…
        receiver.collectedPackets.add(seed);
        document.getElementById('stat-collected').innerText = receiver.collectedPackets.size;

        // è§£ç  Payload
        const binStr = atob(b64);
        const data = new Uint8Array(binStr.length);
        for(let i=0; i<binStr.length; i++) data[i] = binStr.charCodeAt(i);

        // è¿˜åŸ indices
        const indices = LTCodec.getDropletSpecs(seed, total);
        
        // å…¥é˜Ÿå¹¶å°è¯•å‰¥æ´‹è‘±
        receiver.dropletQueue.push({ indices, data });
        receiver.trySolve();
    },

    trySolve: () => {
        let progress = false;
        do {
            progress = false;
            // 1. ç§»é™¤å·²çŸ¥çš„å—
            receiver.dropletQueue.forEach(drop => {
                // è¿‡æ»¤æ‰ indices ä¸­å·²ç»solvedçš„
                const needed = drop.indices.filter(idx => !receiver.solvedBlocks[idx]);
                
                // å¦‚æœè¿‡æ»¤åå˜å°‘äº†ï¼Œè¯´æ˜åŸå…ˆindicesé‡Œæœ‰äº›å·²ç»è§£å‡ºæ¥äº†ï¼Œéœ€è¦å¼‚æˆ–æ‰
                if(needed.length < drop.indices.length) {
                    const solvedIndices = drop.indices.filter(idx => receiver.solvedBlocks[idx]);
                    solvedIndices.forEach(idx => {
                        const solvedData = receiver.solvedBlocks[idx];
                        // XOR out the solved block
                        for(let i=0; i<drop.data.length; i++) drop.data[i] ^= solvedData[i];
                    });
                    // æ›´æ–°è¯¥ droplet çš„ indices ä¸ºå‰©ä½™æœªè§£çš„
                    drop.indices = needed;
                }
            });

            // 2. å¯»æ‰¾åº¦ä¸º1çš„åŒ… (Solvable)
            const solvable = receiver.dropletQueue.find(d => d.indices.length === 1);
            if(solvable) {
                const idx = solvable.indices[0];
                if(!receiver.solvedBlocks[idx]) {
                    receiver.solvedBlocks[idx] = solvable.data;
                    progress = true; // åªè¦è§£å‡ºä¸€ä¸ªï¼Œå°±éœ€è¦é‡æ–°è·‘ä¸€éå¾ªç¯ï¼Œå› ä¸ºè¿™ä¸ªæ–°è§£å‡ºçš„å—å¯èƒ½å¼•å‘è¿é”ååº”
                }
                // ä»é˜Ÿåˆ—ä¸­ç§»é™¤å·²å®Œå…¨è§£å†³çš„åŒ… (æˆ–è€… indices ä¸ºç©ºçš„åŒ…)
                receiver.dropletQueue = receiver.dropletQueue.filter(d => d.indices.length > 0);
            }

        } while(progress);

        receiver.updateProgress();
    },

    updateProgress: () => {
        const solvedCount = Object.keys(receiver.solvedBlocks).length;
        const pct = Math.floor((solvedCount / receiver.totalBlocks) * 100);
        document.getElementById('progress-txt').innerText = pct + '%';
        document.getElementById('progress-bar').style.width = pct + '%';

        if(solvedCount === receiver.totalBlocks && receiver.totalBlocks > 0) {
            receiver.finalize();
        }
    },

    finalize: () => {
        if(!document.getElementById('download-area').classList.contains('hidden')) return;
        
        receiver.scanning = false; // åœæ­¢æ‰«æèŠ‚çœæ€§èƒ½
        document.getElementById('download-area').classList.remove('hidden');
        
        // æ‹¼è£…æ–‡ä»¶
        // éœ€å»æ‰paddingï¼Œä½†ç®€åŒ–ç‰ˆæš‚ä¸å¤„ç†ï¼Œç›´æ¥æ‹¼æ¥
        const totalSize = receiver.totalBlocks * app.chunkSize; // è¿‘ä¼¼å¤§å°
        const finalBuffer = new Uint8Array(receiver.totalBlocks * app.chunkSize);
        
        for(let i=0; i<receiver.totalBlocks; i++) {
            finalBuffer.set(receiver.solvedBlocks[i], i * app.chunkSize);
        }

        // å»é™¤æœ«å°¾ç©ºå­—èŠ‚ (ç®€å•å¤„ç†ï¼šå¯»æ‰¾æœ€åä¸€ä¸ªé0å­—èŠ‚ï¼Œæˆ–è€…ä¾èµ–æ–‡ä»¶æ ¼å¼ï¼Œè¿™é‡Œä¸åšå¤æ‚å»ç©º)
        const blob = new Blob([finalBuffer]);
        const btn = document.getElementById('dl-btn');
        btn.onclick = () => {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = receiver.fileName;
            a.click();
        };
    }
};

// æ–‡ä»¶è¾“å…¥ç›‘å¬
document.getElementById('fileInput').onchange = (e) => {
    const f = e.target.files[0];
    if(!f) return;
    const r = new FileReader();
    r.onload = (ev) => {
        app.fileData = ev.target.result;
        app.fileName = f.name;
        document.getElementById('fileName').innerText = f.name;
        document.getElementById('fileInfo').classList.remove('hidden');
    };
    r.readAsArrayBuffer(f);
};
</script>
</body>
</html>
